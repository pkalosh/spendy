{% extends "partials/dashboard-base.html" %}
{% load static %}
{% load humanize %}
{% load custom_filters %} 

{% block content %}
<link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
<style>
  .hidden {
    display: none;
  }
</style>
<section class="dashboard-section body-collapse">
  <div class="overlay pt-120">
    <div class="container-fluid">
      <div class="col-12">
        <h4 class="mb-1">Expenses</h4>
        <p class="mb-3">Create and track events with categorized expenses.</p>
    </div>

      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#submitExpenseModal">
        New Event/Operation/Activation
      </button>

      <!-- Nav tabs -->
      <ul class="nav nav-tabs mt-4" id="expenseTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="event-tab" data-bs-toggle="tab" data-bs-target="#event" type="button" role="tab" aria-controls="event" aria-selected="true">Events</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="operation-tab" data-bs-toggle="tab" data-bs-target="#operation" type="button" role="tab" aria-controls="operation" aria-selected="false">Operations</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="activation-tab" data-bs-toggle="tab" data-bs-target="#activation" type="button" role="tab" aria-controls="activation" aria-selected="false">Activation</button>
        </li>
      </ul>

      <!-- Tab panes -->
      <div class="tab-content mt-3">
        <!-- Events Tab -->
        <div class="tab-pane fade show active" id="event" role="tabpanel" aria-labelledby="event-tab">
          <div class="table-responsive">
            <table class="display table table-striped" style="width:100%">
              <thead>
                <tr>
                  <th>Event</th>
                  <th>Category</th>
                  <th>Client</th>
                  <th>Budget</th>
                  <th>Created By</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for item in all_items %}
                  {% if item|get_class_name == 'Event' %}
                    <tr>
                      <td>{{ item.name }}</td>
                      <td>{{ item.category }}</td>
                      <td>{{ item.client }}</td>
                      <td>{{ item.budget|intcomma }}</td>
                      <td><a href="#">{{ item.created_by.get_full_name }}</a></td>
                      <td>
                        <a href="{% url 'expense:event_expense_detail' item.id %}" class="btn btn-sm btn-primary">View Expenses</a>
                      </td>
                    </tr>
                  {% endif %}
                {% empty %}
                  <tr><td colspan="6" class="text-center">No event records found.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Operations Tab -->
        <div class="tab-pane fade" id="operation" role="tabpanel" aria-labelledby="operation-tab">
          <div class="table-responsive">
            <table class="display table table-striped" style="width:100%">
              <thead>
                <tr>
                  <th>Operation</th>
                  <th>Category</th>
                  <th>Client</th>
                  <th>Budget</th>
                  <th>Created By</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for item in all_items %}
                  {% if item|get_class_name == 'Operation' %}
                    <tr>
                      <td>{{ item.name }}</td>
                      <td>{{ item.category }}</td>
                      <td>{{ item.client }}</td>
                      <td>{{ item.budget|intcomma }}</td>
                      <td><a href="#">{{ item.created_by.get_full_name }}</a></td>
                      <td>
                        <a href="{% url 'expense:operation_expense_detail' item.id %}" class="btn btn-sm btn-primary">View Expenses</a>
                      </td>
                    </tr>
                  {% endif %}
                {% empty %}
                  <tr><td colspan="6" class="text-center">No operation records found.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Activations Tab -->
        <div class="tab-pane fade" id="activation" role="tabpanel" aria-labelledby="activation-tab">
          <div class="table-responsive">
            <table class="display table table-striped" style="width:100%">
              <thead>
                <tr>
                  <th>Activation</th>
                  <th>Category</th>
                  <th>Client</th>
                  <th>Budget</th>
                  <th>Project Lead</th>
                  <th>Created By</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for item in all_items %}
                  {% if item|get_class_name == 'Activation' %}
                    <tr>
                      <td>{{ item.name }}</td>
                      <td>{{ item.category }}</td>
                      <td>{{ item.client|default:"N/A" }}</td>
                      <td>{{ item.budget|intcomma|default:"N/A" }}</td>
                      <td>{{ item.project_lead|default:"N/A" }}</td>
                      <td><a href="#">{{ item.created_by.get_full_name|default:"N/A" }}</a></td>
                      <td>
                        {% if item.approved %}
                          <span class="badge bg-success">Approved</span>
                        {% else %}
                          <span class="badge bg-warning">Pending</span>
                        {% endif %}
                        {% if item.paid %}
                          <span class="badge bg-info">Paid</span>
                        {% endif %}
                      </td>
                      <td>
                        <a href="{% url 'expense:activation_expense_detail' item.id %}" class="btn btn-sm btn-primary">View Expenses</a>
                      </td>
                    </tr>
                  {% endif %}
                {% empty %}
                  <tr><td colspan="8" class="text-center">No activation records found.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>
</section>

<!-- Submit Expense Modal -->
<div class="modal fade" id="submitExpenseModal" tabindex="-1" aria-labelledby="submitExpenseModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-light">
        <h5 class="modal-title">Create Event, Activation or Operation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Request Form -->
        <div id="requests" class="content-section">
          <form id="expenseForm" class="bg-white p-4 shadow rounded" method="post" action="{% url 'expense:event-operation' %}" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="form_type" id="form_type" value="">
            
            <!-- Request Type -->
            <div class="mb-3">
              <label for="requestType" class="form-label fw-bold">Expense Group</label>
              <select id="requestType" name="request_type" class="form-select" onchange="toggleRequestFields()" required>
                <option value="">Select Type</option>
                <option value="event">Event</option>
                <option value="operation">Operation</option>
                <option value="activation">Activation</option>
              </select>
            </div>
            
            <!-- Event Request Fields -->
            <div id="eventRequestFields" class="hidden">
              <div class="mb-3">
                <label for="event_name" class="form-label">Event Name</label>
                <input type="text" id="event_name" name="event_name" class="form-control event-field" maxlength="255">
              </div>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="event_category" class="form-label">Event Category</label>
                  <select id="event_category" name="event_category" class="form-select event-field">
                    <option value="">Select Category</option>
                    {% for category in event_categories %}
                      <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="event_client" class="form-label">Client</label>
                  <select id="event_client" name="event_client" class="form-select event-field">
                    <option value="">Select Client</option>
                    {% for client in clients %}
                      <option value="{{ client.id }}">{{ client.name }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="event_start_date" class="form-label">Start Date</label>
                  <input type="date" id="event_start_date" name="event_start_date" class="form-control event-field">
                </div>
                <div class="col-md-6 mb-3">
                  <label for="event_end_date" class="form-label">End Date</label>
                  <input type="date" id="event_end_date" name="event_end_date" class="form-control event-field">
                </div>
              </div>
              
              <div class="mb-3">
                <label for="event_budget" class="form-label">Budget</label>
                <input type="number" id="event_budget" name="event_budget" class="form-control event-field" step="0.01">
              </div>
              
              <div class="mb-3">
                <label for="event_budget_file" class="form-label">Budget File <span class="text-muted">(Optional)</span></label>
                <input type="file" id="event_budget_file" name="event_budget_file" class="form-control" accept=".pdf,.doc,.docx,.xls,.xlsx">
              </div>
              
              <div class="mb-3">
                <label for="event_project_lead" class="form-label">Project Lead</label>
                <input type="text" id="event_project_lead" name="event_project_lead" class="form-control event-field" maxlength="255">
              </div>
              
              <div class="mb-3">
                <label for="event_location" class="form-label">Location</label>
                <input type="text" id="event_location" name="event_location" class="form-control event-field" maxlength="255">
              </div>
            </div>
            
            <!-- Operation Request Fields -->
            <div id="operationRequestFields" class="hidden">
              <div class="mb-3">
                <label for="operation_name" class="form-label">Operation Name</label>
                <input type="text" id="operation_name" name="operation_name" class="form-control operation-field" maxlength="255">
              </div>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="operation_category" class="form-label">Operation Category</label>
                  <select id="operation_category" name="operation_category" class="form-select operation-field">
                    <option value="">Select Category</option>
                    {% for category in operation_categories %}
                      <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="operation_client" class="form-label">Client</label>
                  <select id="operation_client" name="operation_client" class="form-select operation-field">
                    <option value="">Select Client</option>
                    {% for client in clients %}
                      <option value="{{ client.id }}">{{ client.name }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              
              <div class="mb-3">
                <label for="operation_budget" class="form-label">Budget</label>
                <input type="number" id="operation_budget" name="operation_budget" class="form-control operation-field" step="0.01">
              </div>
              
              <div class="mb-3">
                <label for="operation_budget_file" class="form-label">Budget File <span class="text-muted">(Optional)</span></label>
                <input type="file" id="operation_budget_file" name="operation_budget_file" class="form-control" accept=".pdf,.doc,.docx,.xls,.xlsx">
              </div>
              
              <div class="mb-3">
                <label for="operation_project_lead" class="form-label">Project Lead</label>
                <input type="text" id="operation_project_lead" name="operation_project_lead" class="form-control operation-field" maxlength="255">
              </div>
            </div>
            
            <!-- Activation Request Fields -->
            <div id="activationRequestFields" class="hidden">
              <div class="mb-3">
                <label for="activation_name" class="form-label">Activation Name</label>
                <input type="text" id="activation_name" name="activation_name" class="form-control activation-field" maxlength="255">
              </div>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="activation_category" class="form-label">Activation Category</label>
                  <select id="activation_category" name="activation_category" class="form-select activation-field">
                    <option value="">Select Category</option>
                    {% for category in activation_categories %}
                      <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="activation_client" class="form-label">Client</label>
                  <select id="activation_client" name="activation_client" class="form-select activation-field">
                    <option value="">Select Client</option>
                    {% for client in clients %}
                      <option value="{{ client.id }}">{{ client.name }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              
              <div class="mb-3">
                <label for="activation_budget" class="form-label">Budget <span class="text-muted">(Optional)</span></label>
                <input type="number" id="activation_budget" name="activation_budget" class="form-control" step="0.01">
              </div>
              
              <div class="mb-3">
                <label for="activation_budget_file" class="form-label">Budget File <span class="text-muted">(Optional)</span></label>
                <input type="file" id="activation_budget_file" name="activation_budget_file" class="form-control" accept=".pdf,.doc,.docx,.xls,.xlsx">
              </div>
              
              <div class="mb-3">
                <label for="activation_project_lead" class="form-label">Project Lead <span class="text-muted">(Optional)</span></label>
                <input type="text" id="activation_project_lead" name="activation_project_lead" class="form-control" maxlength="255">
              </div>
              
              <div class="mb-3">
                <label for="activation_description" class="form-label">Description <span class="text-muted">(Optional)</span></label>
                <textarea id="activation_description" name="activation_description" class="form-control" rows="4" placeholder="Describe the activation details..."></textarea>
              </div>
            </div>
            
            <button type="submit" class="btn btn-primary mt-3">Save</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function toggleRequestFields() {
    let requestType = document.getElementById('requestType').value;
    document.getElementById('form_type').value = requestType;
    
    // Show/hide appropriate fields
    document.getElementById('eventRequestFields').classList.toggle('hidden', requestType !== 'event');
    document.getElementById('operationRequestFields').classList.toggle('hidden', requestType !== 'operation');
    document.getElementById('activationRequestFields').classList.toggle('hidden', requestType !== 'activation');
    
    // Remove required attribute from all fields first
    const allFields = document.querySelectorAll('.event-field, .operation-field, .activation-field');
    allFields.forEach(field => {
      field.removeAttribute('required');
      // Also remove any existing validation styling
      field.classList.remove('is-invalid');
    });
    
    // Set required attributes based on request type
    if (requestType === 'event') {
      const eventFields = document.querySelectorAll('.event-field');
      eventFields.forEach(field => {
        field.setAttribute('required', '');
      });
    } else if (requestType === 'operation') {
      const operationFields = document.querySelectorAll('.operation-field');
      operationFields.forEach(field => {
        field.setAttribute('required', '');
      });
    } else if (requestType === 'activation') {
      // Only name and category are required for activations based on your model
      const requiredActivationFields = ['activation_name', 'activation_category', 'activation_client'];
      requiredActivationFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.setAttribute('required', '');
        }
      });
    }
  }
  
  // Form validation and submission
  document.addEventListener('DOMContentLoaded', function() {
    const expenseForm = document.getElementById('expenseForm');
    
    expenseForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const requestType = document.getElementById('requestType').value;
      let isValid = true;
      let errorMessage = '';
      
      // Basic validation
      if (!requestType) {
        errorMessage = 'Please select a request type';
        isValid = false;
      } else if (requestType === 'event') {
        // Validate event fields
        const eventName = document.getElementById('event_name').value.trim();
        const eventCategory = document.getElementById('event_category').value;
        const eventClient = document.getElementById('event_client').value;
        const eventStartDate = document.getElementById('event_start_date').value;
        const eventEndDate = document.getElementById('event_end_date').value;
        const eventBudget = document.getElementById('event_budget').value;
        const eventProjectLead = document.getElementById('event_project_lead').value.trim();
        const eventLocation = document.getElementById('event_location').value.trim();
        
        if (!eventName) {
          errorMessage = 'Event name is required';
          isValid = false;
        } else if (!eventCategory) {
          errorMessage = 'Event category is required';
          isValid = false;
        } else if (!eventClient) {
          errorMessage = 'Event client is required';
          isValid = false;
        } else if (!eventStartDate) {
          errorMessage = 'Event start date is required';
          isValid = false;
        } else if (!eventEndDate) {
          errorMessage = 'Event end date is required';
          isValid = false;
        } else if (!eventBudget) {
          errorMessage = 'Event budget is required';
          isValid = false;
        } else if (!eventProjectLead) {
          errorMessage = 'Project lead is required';
          isValid = false;
        } else if (!eventLocation) {
          errorMessage = 'Event location is required';
          isValid = false;
        }
        
        // Validate dates
        if (isValid && eventStartDate && eventEndDate && new Date(eventStartDate) > new Date(eventEndDate)) {
          errorMessage = 'End date must be after start date';
          isValid = false;
        }
        
        // Validate budget
        if (isValid && eventBudget && parseFloat(eventBudget) < 0) {
          errorMessage = 'Budget cannot be negative';
          isValid = false;
        }
        
      } else if (requestType === 'operation') {
        // Validate operation fields
        const operationName = document.getElementById('operation_name').value.trim();
        const operationCategory = document.getElementById('operation_category').value;
        const operationClient = document.getElementById('operation_client').value;
        const operationBudget = document.getElementById('operation_budget').value;
        const operationProjectLead = document.getElementById('operation_project_lead').value.trim();
        
        if (!operationName) {
          errorMessage = 'Operation name is required';
          isValid = false;
        } else if (!operationCategory) {
          errorMessage = 'Operation category is required';
          isValid = false;
        } else if (!operationClient) {
          errorMessage = 'Operation client is required';
          isValid = false;
        } else if (!operationBudget) {
          errorMessage = 'Operation budget is required';
          isValid = false;
        } else if (!operationProjectLead) {
          errorMessage = 'Project lead is required';
          isValid = false;
        }
        
        // Validate budget
        if (isValid && operationBudget && parseFloat(operationBudget) < 0) {
          errorMessage = 'Budget cannot be negative';
          isValid = false;
        }
        
      } else if (requestType === 'activation') {
        // Validate activation fields (only name, category, and client are required)
        const activationName = document.getElementById('activation_name').value.trim();
        const activationCategory = document.getElementById('activation_category').value;
        const activationClient = document.getElementById('activation_client').value;
        const activationBudget = document.getElementById('activation_budget').value;
        
        if (!activationName) {
          errorMessage = 'Activation name is required';
          isValid = false;
        } else if (!activationCategory) {
          errorMessage = 'Activation category is required';
          isValid = false;
        } else if (!activationClient) {
          errorMessage = 'Activation client is required';
          isValid = false;
        }
        
        // Validate budget if provided
        if (isValid && activationBudget && parseFloat(activationBudget) < 0) {
          errorMessage = 'Budget cannot be negative';
          isValid = false;
        }
      }
      
      if (!isValid) {
        alert(errorMessage);
        return false;
      }
      
      // If validation passes, submit the form
      this.submit();
    });
    
    // Initialize field visibility on page load
    toggleRequestFields();
  });
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

{% endblock %}