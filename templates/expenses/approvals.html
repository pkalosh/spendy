{% extends "partials/dashboard-base.html" %}
{% load static %}
{% load humanize %}
{% load custom_filters %}
{% block content %}
<style>
:root {
  --primary-color: #98e23f;
  --secondary-color: #7ab82c;
  --success-color: #10b981;
  --warning-color: #f59e0b;
  --danger-color: #ef4444;
  --info-color: #06b6d4;
  --light-bg: #f8fafc;
  --dark-text: #1f2937;
  --muted-text: #6b7280;
  --border-color: #e5e7eb;
  --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
  --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
  --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
  --border-radius: 12px;
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
body {
  background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
}
.dashboard-section {
  min-height: 100vh;
  background: transparent;
}
/* Section Header */
.section-header {
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  border-radius: var(--border-radius);
  padding: 2rem;
  margin-bottom: 2rem;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-color);
  position: relative;
  overflow: hidden;
}
.section-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
  z-index: 1;
}
.section-title {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--dark-text);
  margin-bottom: 0.5rem;
  position: relative;
  z-index: 2;
}
.section-title.text-gradient {
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.section-subtitle {
  color: var(--muted-text);
  font-size: 0.875rem;
  position: relative;
  z-index: 2;
}
/* Nav Tabs */
.nav-tabs {
  border: none;
  background: white;
  border-radius: var(--border-radius);
  padding: 0.5rem;
  box-shadow: var(--shadow-sm);
  margin-bottom: 1rem;
}
.nav-tabs .nav-link {
  border: none;
  color: var(--muted-text);
  font-weight: 600;
  padding: 0.75rem 1.5rem;
  border-radius: 8px;
  transition: var(--transition);
  margin: 0 0.25rem;
}
.nav-tabs .nav-link:hover {
  color: var(--primary-color);
  background: rgba(152, 226, 63, 0.1);
}
.nav-tabs .nav-link.active {
  background: var(--primary-color);
  color: white;
  box-shadow: var(--shadow-sm);
}
.nav-tabs .badge {
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: none;
}
/* Filter Card */
.card {
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  box-shadow: var(--shadow-sm);
  transition: var(--transition);
  background: white;
}
.card:hover {
  box-shadow: var(--shadow-md);
}
/* Button Enhancements */
.btn-primary {
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  border: none;
  color: white;
  border-radius: var(--border-radius);
  font-weight: 600;
  transition: var(--transition);
  box-shadow: var(--shadow-sm);
  padding: 0.75rem 1.5rem;
}
.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
  color: white;
}
.btn-success {
  background: linear-gradient(135deg, var(--success-color), #059669);
  border: none;
  border-radius: var(--border-radius);
  font-weight: 600;
  transition: var(--transition);
  box-shadow: var(--shadow-sm);
}
.btn-success:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
  color: white;
}
.btn-warning {
  background: linear-gradient(135deg, var(--warning-color), #d97706);
  border: none;
  border-radius: var(--border-radius);
  font-weight: 600;
  transition: var(--transition);
  box-shadow: var(--shadow-sm);
  color: white;
}
.btn-warning:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
  color: white;
}
.btn-danger {
  background: linear-gradient(135deg, var(--danger-color), #dc2626);
  border: none;
  border-radius: var(--border-radius);
  font-weight: 600;
  transition: var(--transition);
  box-shadow: var(--shadow-sm);
  color: white;
}
.btn-danger:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
  color: white;
}
.btn-outline-primary {
  border: 1px solid var(--primary-color);
  color: var(--primary-color);
  background: transparent;
  border-radius: var(--border-radius);
  font-weight: 600;
  transition: var(--transition);
}
.btn-outline-primary:hover {
  background: var(--primary-color);
  color: white;
  transform: translateY(-1px);
  box-shadow: var(--shadow-sm);
}
.btn-outline-secondary {
  border: 1px solid var(--border-color);
  color: var(--muted-text);
  background: transparent;
  border-radius: var(--border-radius);
  font-weight: 600;
  transition: var(--transition);
}
.btn-outline-secondary:hover {
  background: var(--light-bg);
  color: var(--dark-text);
  transform: translateY(-1px);
}
.btn-outline-info {
  border: 1px solid var(--info-color);
  color: var(--info-color);
  background: transparent;
  border-radius: var(--border-radius);
  font-weight: 600;
  transition: var(--transition);
}
.btn-outline-info:hover {
  background: var(--info-color);
  color: white;
  transform: translateY(-1px);
  box-shadow: var(--shadow-sm);
}
/* Badge Enhancements */
.badge {
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.025em;
  padding: 0.5rem 0.75rem;
  border: 1px solid;
}
.bg-primary {
  background: rgba(59, 130, 246, 0.1) !important;
  color: var(--primary-color) !important;
  border-color: rgba(59, 130, 246, 0.2);
}
.bg-secondary {
  background: rgba(107, 114, 128, 0.1) !important;
  color: var(--muted-text) !important;
  border-color: rgba(107, 114, 128, 0.2);
}
.bg-info {
  background: rgba(6, 182, 212, 0.1) !important;
  color: var(--info-color) !important;
  border-color: rgba(6, 182, 212, 0.2);
}
.bg-success {
  background: rgba(16, 185, 129, 0.1) !important;
  color: var(--success-color) !important;
  border-color: rgba(16, 185, 129, 0.2);
}
.bg-warning {
  background: rgba(245, 158, 11, 0.1) !important;
  color: var(--warning-color) !important;
  border-color: rgba(245, 158, 11, 0.2);
}
.bg-danger {
  background: rgba(239, 68, 68, 0.1) !important;
  color: var(--danger-color) !important;
  border-color: rgba(239, 68, 68, 0.2);
}
/* Table Enhancements */
.table-responsive {
  border-radius: var(--border-radius);
  overflow: hidden;
  box-shadow: var(--shadow-sm);
  background: white;
}
.table {
  margin-bottom: 0;
}
.table thead th {
  border-bottom: 2px solid var(--border-color);
  font-weight: 600;
  color: var(--dark-text);
  padding: 1rem 0.75rem;
  background: var(--light-bg);
}
.table tbody td {
  padding: 1rem 0.75rem;
  border-bottom: 1px solid #f1f5f9;
  vertical-align: middle;
}
.table tbody tr:hover {
  background: rgba(152, 226, 63, 0.05);
  transition: var(--transition);
  transform: scale(1.01);
}
.table-dark {
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  color: white;
}
.table-dark th {
  color: white;
  background: transparent;
}
/* Modal Enhancements */
.modal-content {
  border: none;
  border-radius: var(--border-radius);
  box-shadow: var(--shadow-lg);
}
.modal-header {
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  color: white;
  border-radius: var(--border-radius) var(--border-radius) 0 0;
}
.modal-body {
  background: #f8fafc;
}
.modal-footer {
  border-top: 1px solid var(--border-color);
}
/* Form Elements */
.form-control, .form-select {
  border: 1px solid var(--border-color);
  border-radius: 8px;
  transition: var(--transition);
}
.form-control:focus, .form-select:focus {
  border-color: var(--primary-color);
  box-shadow: 0 0 0 0.2rem rgba(152, 226, 63, 0.25);
}
.is-invalid {
  border-color: var(--danger-color);
}
.is-valid {
  border-color: var(--success-color);
}
/* Empty States */
.empty-state {
  text-align: center;
  padding: 3rem 2rem;
  border-radius: var(--border-radius);
  background: linear-gradient(135deg, rgba(152, 226, 63, 0.05) 0%, rgba(122, 184, 44, 0.05) 100%);
  border: 1px solid rgba(152, 226, 63, 0.2);
}
.empty-state i {
  color: var(--primary-color);
  opacity: 0.7;
  transition: var(--transition);
}
.empty-state:hover i {
  transform: scale(1.1);
}
/* Pagination */
.pagination .page-link {
  border: 1px solid var(--border-color);
  color: var(--dark-text);
  padding: 0.5rem 0.75rem;
  margin: 0 0.125rem;
  border-radius: 6px;
  transition: var(--transition);
}
.pagination .page-link:hover {
  background: var(--primary-color);
  color: white;
  border-color: var(--primary-color);
  transform: translateY(-1px);
}
.pagination .page-item.active .page-link {
  background: var(--primary-color);
  border-color: var(--primary-color);
  box-shadow: var(--shadow-sm);
}
/* Dropdown Menu */
.dropdown-menu {
  border: none;
  box-shadow: var(--shadow-lg);
  border-radius: 8px;
  backdrop-filter: blur(10px);
  background: rgba(255, 255, 255, 0.95);
}
.dropdown-item {
  transition: var(--transition);
}
.dropdown-item:hover {
  background: rgba(152, 226, 63, 0.1);
  color: var(--primary-color);
}
/* Responsive Design */
@media (max-width: 768px) {
  .section-header {
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }
  .nav-tabs {
    flex-direction: column;
  }
  .nav-tabs .nav-link {
    margin: 0.25rem 0;
  }
  .btn-group-vertical {
    flex-direction: row !important;
  }
  .btn-group-vertical .btn {
    margin-right: 0.5rem;
  }
  .table thead {
    display: none;
  }
  .table tbody tr {
    display: block;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    margin-bottom: 1rem;
    padding: 1rem;
    background: white;
    box-shadow: var(--shadow-sm);
  }
  .table tbody td {
    display: block;
    border: none;
    padding: 0.25rem 0;
    text-align: left;
  }
  .table tbody td:before {
    content: attr(data-label) ": ";
    font-weight: 600;
    color: var(--dark-text);
  }
}
</style>
<section class="dashboard-section body-collapse">
  <div class="overlay pt-4 pt-md-5">
    <div class="container-fluid">
      <div class="row mt-4">
        <div class="col-12">
          <div class="section-header">
            <h4 class="section-title text-gradient mb-3">Expense Approvals</h4>
            <p class="section-subtitle mb-0">Review and approve Activation/Event/Operational expense requests.</p>
          </div>
        </div>
        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs mb-4" id="approvalTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link {% if active_tab == 'activation' or not active_tab %}active{% endif %}"
                    id="activation-tab" data-bs-toggle="tab" data-bs-target="#activation"
                    type="button" role="tab" aria-controls="activation"
                    aria-selected="{% if active_tab == 'activation' or not active_tab %}true{% else %}false{% endif %}"
                    data-tab="activation">
              Activation Requests
              <span class="badge bg-secondary ms-1" id="activation-count">{{ activation_summary.total }}</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link {% if active_tab == 'event' %}active{% endif %}"
                    id="event-tab" data-bs-toggle="tab" data-bs-target="#event"
                    type="button" role="tab" aria-controls="event"
                    aria-selected="{% if active_tab == 'event' %}true{% else %}false{% endif %}"
                    data-tab="event">
              Event Requests
              <span class="badge bg-secondary ms-1" id="event-count">{{ event_summary.total }}</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link {% if active_tab == 'operation' %}active{% endif %}"
                    id="operation-tab" data-bs-toggle="tab" data-bs-target="#operation"
                    type="button" role="tab" aria-controls="operation"
                    aria-selected="{% if active_tab == 'operation' %}true{% else %}false{% endif %}"
                    data-tab="operation">
              Operation Requests
              <span class="badge bg-secondary ms-1" id="operation-count">{{ operation_summary.total }}</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link {% if active_tab == 'history' %}active{% endif %}"
                    id="history-tab" data-bs-toggle="tab" data-bs-target="#history"
                    type="button" role="tab" aria-controls="history"
                    aria-selected="{% if active_tab == 'history' %}true{% else %}false{% endif %}"
                    data-tab="history">
              Request History
              <span class="badge bg-secondary ms-1" id="history-count">{{ history_summary.total }}</span>
            </button>
          </li>
        </ul>
        <!-- Filter Controls -->
        <div class="card mb-4">
          <div class="card-body">
            <form method="get" id="filterForm">
              <div class="row align-items-center">
                <div class="col-md-6 mb-3 mb-md-0">
                  <div class="btn-group" role="group" aria-label="Request filter">
                    <button type="button" class="btn btn-outline-primary {% if status == 'all' or not status %}active{% endif %}" data-filter="all">
                      All
                      <span class="badge bg-primary ms-1">
                        {% if active_tab == 'activation' or not active_tab %}{{ activation_summary.all|default:0 }}{% elif active_tab == 'event' %}{{ event_summary.all|default:0 }}{% elif active_tab == 'operation' %}{{ operation_summary.all|default:0 }}{% else %}{{ history_summary.all|default:0 }}{% endif %}
                      </span>
                    </button>
                    <button type="button" class="btn btn-outline-warning {% if status == 'pending' %}active{% endif %}" data-filter="pending">
                      Pending
                      <span class="badge bg-warning ms-1">
                        {% if active_tab == 'activation' or not active_tab %}{{ activation_summary.pending|default:0 }}{% elif active_tab == 'event' %}{{ event_summary.pending|default:0 }}{% elif active_tab == 'operation' %}{{ operation_summary.pending|default:0 }}{% else %}{{ history_summary.pending|default:0 }}{% endif %}
                      </span>
                    </button>
                    <button type="button" class="btn btn-outline-success {% if status == 'approved' %}active{% endif %}" data-filter="approved">
                      Approved
                      <span class="badge bg-success ms-1">
                        {% if active_tab == 'activation' or not active_tab %}{{ activation_summary.approved|default:0 }}{% elif active_tab == 'event' %}{{ event_summary.approved|default:0 }}{% elif active_tab == 'operation' %}{{ operation_summary.approved|default:0 }}{% else %}{{ history_summary.approved|default:0 }}{% endif %}
                      </span>
                    </button>
                    <button type="button" class="btn btn-outline-danger {% if status == 'rejected' %}active{% endif %}" data-filter="rejected">
                      Rejected
                      <span class="badge bg-danger ms-1">
                        {% if active_tab == 'activation' or not active_tab %}{{ activation_summary.rejected|default:0 }}{% elif active_tab == 'event' %}{{ event_summary.rejected|default:0 }}{% elif active_tab == 'operation' %}{{ operation_summary.rejected|default:0 }}{% else %}{{ history_summary.rejected|default:0 }}{% endif %}
                      </span>
                    </button>
                  </div>
                </div>
                <div class="col-md-4 mb-3 mb-md-0">
                  <input type="text" class="form-control" id="searchInput" name="q" placeholder="Search requests..." value="{{ query }}">
                </div>
                <div class="col-md-2">
                  <div class="dropdown">
                    <button class="btn btn-outline-info dropdown-toggle w-100" type="button"
                            id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                      <i class="fas fa-download"></i> Export
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="exportDropdown">
                      <li><a class="dropdown-item" href="#" data-export-type="csv">
                        <i class="fas fa-file-csv"></i> Export CSV
                      </a></li>
                      <li><a class="dropdown-item" href="#" data-export-type="pdf">
                        <i class="fas fa-file-pdf"></i> Export PDF
                      </a></li>
                      <li><a class="dropdown-item" href="#" data-export-type="excel">
                        <i class="fas fa-file-excel"></i> Export Excel
                      </a></li>
                    </ul>
                  </div>
                </div>
              </div>
              <input type="hidden" name="status" id="statusFilter" value="{{ status|default:'all' }}">
              <input type="hidden" name="tab" id="tabFilter" value="{{ active_tab|default:'activation' }}">
            </form>
          </div>
        </div>
        <!-- Tabs Content -->
        <div class="tab-content" id="approvalTabsContent">
          <!-- Activation Requests Tab -->
          <div class="tab-pane fade {% if active_tab == 'activation' or not active_tab %}show active{% endif %}"
               id="activation" role="tabpanel" aria-labelledby="activation-tab">
            <div class="table-responsive">
              <table class="table table-bordered table-striped" id="activationTable">
                <thead class="table-dark">
                  <tr>
                    <th>Requested By</th>
                    <th>Type</th>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Amount</th>
                    <th>Description</th>
                    <th>Date Requested</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  {% for expense in activation_requests %}
                  <tr data-status="pending"
                      data-expense-id="{{ expense.id }}"
                      data-search="{{ expense.created_by.get_full_name|lower }} {{ expense.activation.name|lower }} {{ expense.expense_category.name|lower }} {{ expense.description|lower }}"
                      data-batch-disbursement="{{ expense.batch_disbursement_type }}">
                    <td data-label="Requested By">
                      <div class="d-flex align-items-center">
                        <div>
                          <strong>{{ expense.created_by.get_full_name }}</strong>
                          <br>
                          <small class="text-muted">{{ expense.created_by.email }}</small>
                        </div>
                      </div>
                    </td>
                    <td data-label="Type">
                      <span class="badge bg-primary">Activation</span>
                    </td>
                    <td data-label="Name">
                      <strong>{{ expense.activation.name }}</strong>
                      <br>
                      <small class="text-muted">{{ expense.activation.category.name }}</small>
                    </td>
                    <td data-label="Category">
                      <span class="badge bg-info">{{ expense.expense_category.name }}</span>
                    </td>
                    <td data-label="Amount">
                      <strong>KSH {{ expense.amount|floatformat:2|intcomma }}</strong>
                    </td>
                    <td data-label="Description">
                      <div class="description-cell">
                        {{ expense.description|truncatewords:10 }}
                        {% if expense.description|length > 50 %}
                        <br>
                        <small>
                          <a href="#" class="text-primary view-full-description"
                             data-full-description="{{ expense.description }}">View full description</a>
                        </small>
                        {% endif %}
                      </div>
                    </td>
                    <td data-label="Date Requested">
                      <small>{{ expense.created_at|date:"M d, Y" }}<br>{{ expense.created_at|time:"g:i A" }}</small>
                    </td>
                    <td data-label="Action">
                      <div class="btn-group-vertical" role="group">
                        <button class="btn btn-success btn-sm approve-btn"
                                data-bs-toggle="modal" data-bs-target="#approveModal"
                                data-expense-id="{{ expense.id }}"
                                data-expense-type="activation"
                                data-requester="{{ expense.created_by.get_full_name }}"
                                data-amount="KSH {{ expense.amount|floatformat:2|intcomma }}"
                                data-description="{{ expense.description }}"
                                data-item-name="{{ expense.activation.name }}"
                                data-batch-disbursement="{{ expense.batch_disbursement_type }}">
                            Approve
                        </button>
                        <button class="btn btn-danger btn-sm reject-btn"
                                data-bs-toggle="modal" data-bs-target="#rejectModal"
                                data-expense-id="{{ expense.id }}"
                                data-expense-type="activation"
                                data-requester="{{ expense.created_by.get_full_name }}"
                                data-amount="KSH {{ expense.amount|floatformat:2|intcomma }}"
                                data-description="{{ expense.description }}"
                                data-item-name="{{ expense.activation.name }}">
                            Reject
                        </button>
                      </div>
                    </td>
                  </tr>
                  {% empty %}
                  <tr class="no-results">
                    <td colspan="8" class="text-center py-4">
                      <div class="empty-state">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5>No pending activation requests found</h5>
                        <p class="text-muted">
                          {% if query %}
                          No pending activation requests match your search criteria.
                          {% else %}
                          There are no pending activation expense requests at the moment.
                          {% endif %}
                        </p>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <!-- Activation Pagination -->
            {% if activation_requests.has_other_pages %}
            <nav aria-label="Activation requests pagination">
              <ul class="pagination justify-content-center">
                {% if activation_requests.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?activation_page={{ activation_requests.previous_page_number }}&q={{ query }}&status={{ status }}&tab=activation">Previous</a>
                </li>
                {% endif %}
                {% for num in activation_requests.paginator.page_range %}
                  {% if activation_requests.number == num %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                  {% elif num > activation_requests.number|add:'-3' and num < activation_requests.number|add:'3' %}
                    <li class="page-item"><a class="page-link" href="?activation_page={{ num }}&q={{ query }}&status={{ status }}&tab=activation">{{ num }}</a></li>
                  {% endif %}
                {% endfor %}
                {% if activation_requests.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?activation_page={{ activation_requests.next_page_number }}&q={{ query }}&status={{ status }}&tab=activation">Next</a>
                </li>
                {% endif %}
              </ul>
            </nav>
            {% endif %}
          </div>
          <!-- Event Requests Tab -->
          <div class="tab-pane fade {% if active_tab == 'event' %}show active{% endif %}"
               id="event" role="tabpanel" aria-labelledby="event-tab">
            <div class="table-responsive">
              <table class="table table-bordered table-striped" id="eventTable">
                <thead class="table-dark">
                  <tr>
                    <th>Requested By</th>
                    <th>Event Name</th>
                    <th>Category</th>
                    <th>Amount</th>
                    <th>Description</th>
                    <th>Location</th>
                    <th>Date Requested</th>
                    <th>Status</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  {% for expense in event_requests %}
                  <tr data-status="{% if expense.approved %}approved{% elif expense.declined %}rejected{% else %}pending{% endif %}"
                      data-expense-id="{{ expense.id }}"
                      data-search="{{ expense.created_by.get_full_name|lower }} {{ expense.event.name|lower }} {{ expense.expense_category.name|lower }} {{ expense.description|lower }}"
                      data-batch-disbursement="{{ expense.batch_disbursement_type }}">
                    <td data-label="Requested By">
                      <div class="d-flex align-items-center">
                        <div>
                          <strong>{{ expense.created_by.get_full_name }}</strong>
                          <br>
                          <small class="text-muted">{{ expense.created_by.email }}</small>
                        </div>
                      </div>
                    </td>
                    <td data-label="Event Name">
                      <strong>{{ expense.event.name }}</strong>
                      <br>
                      <small class="text-muted">{{ expense.event.date|date:"M d, Y" }}</small>
                    </td>
                    <td data-label="Category">
                      <span class="badge bg-info">{{ expense.expense_category.name }}</span>
                    </td>
                    <td data-label="Amount">
                      <strong>KSH {{ expense.amount|floatformat:2|intcomma }}</strong>
                    </td>
                    <td data-label="Description">
                      <div class="description-cell">
                        {{ expense.description|truncatewords:10 }}
                        {% if expense.description|length > 50 %}
                        <br>
                        <small>
                          <a href="#" class="text-primary view-full-description"
                             data-full-description="{{ expense.description }}">View full description</a>
                        </small>
                        {% endif %}
                      </div>
                    </td>
                    <td data-label="Location">{{ expense.event.location|default:"—" }}</td>
                    <td data-label="Date Requested">
                      <small>{{ expense.created_at|date:"M d, Y" }}<br>{{ expense.created_at|time:"g:i A" }}</small>
                    </td>
                    <td data-label="Status">
                      {% if expense.approved %}
                        <span class="badge bg-success">Approved</span>
                        {% if expense.approved_by %}
                        <br><small class="text-muted">by {{ expense.approved_by.get_full_name }}</small>
                        {% endif %}
                      {% elif expense.declined %}
                        <span class="badge bg-danger">Rejected</span>
                        {% if expense.decline_reason %}
                        <br><small class="text-muted view-decline-reason"
                                   data-full-reason="{{ expense.decline_reason }}">
                          Reason: {{ expense.decline_reason|truncatewords:3 }}
                        </small>
                        {% endif %}
                      {% else %}
                        <span class="badge bg-warning text-dark">Pending</span>
                      {% endif %}
                    </td>
                    <td data-label="Action">
                      {% if not expense.approved and not expense.declined %}
                      <div class="btn-group-vertical" role="group">
                        <button class="btn btn-success btn-sm approve-btn"
                                data-bs-toggle="modal" data-bs-target="#approveModal"
                                data-expense-id="{{ expense.id }}"
                                data-expense-type="event"
                                data-requester="{{ expense.created_by.get_full_name }}"
                                data-amount="KSH {{ expense.amount|floatformat:2|intcomma }}"
                                data-description="{{ expense.description }}"
                                data-item-name="{{ expense.event.name }}"
                                data-batch-disbursement="{{ expense.batch_disbursement_type }}">
                            Approve
                        </button>
                        <button class="btn btn-danger btn-sm reject-btn"
                                data-bs-toggle="modal" data-bs-target="#rejectModal"
                                data-expense-id="{{ expense.id }}"
                                data-expense-type="event"
                                data-requester="{{ expense.created_by.get_full_name }}"
                                data-amount="KSH {{ expense.amount|floatformat:2|intcomma }}"
                                data-description="{{ expense.description }}"
                                data-item-name="{{ expense.event.name }}">
                            Reject
                        </button>
                      </div>
                      {% else %}
                      <button class="btn btn-warning btn-sm undo-btn"
                              data-bs-toggle="modal" data-bs-target="#undoModal"
                              data-expense-id="{{ expense.id }}"
                              data-expense-type="event"
                              data-requester="{{ expense.created_by.get_full_name }}"
                              data-amount="KSH {{ expense.amount|floatformat:2|intcomma }}"
                              data-description="{{ expense.description }}"
                              data-item-name="{{ expense.event.name }}"
                              data-status="{% if expense.approved %}approved{% else %}rejected{% endif %}">
                        Undo
                      </button>
                      {% endif %}
                    </td>
                  </tr>
                  {% empty %}
                  <tr class="no-results">
                    <td colspan="9" class="text-center py-4">
                      <div class="empty-state">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5>No event requests found</h5>
                        <p class="text-muted">
                          {% if query %}
                          No requests match your search criteria.
                          {% else %}
                          There are no event expense requests at the moment.
                          {% endif %}
                        </p>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <!-- Event Pagination -->
            {% if event_requests.has_other_pages %}
            <nav aria-label="Event requests pagination">
              <ul class="pagination justify-content-center">
                {% if event_requests.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?event_page={{ event_requests.previous_page_number }}&q={{ query }}&status={{ status }}&tab=event">Previous</a>
                </li>
                {% endif %}
                {% for num in event_requests.paginator.page_range %}
                  {% if event_requests.number == num %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                  {% elif num > event_requests.number|add:'-3' and num < event_requests.number|add:'3' %}
                    <li class="page-item"><a class="page-link" href="?event_page={{ num }}&q={{ query }}&status={{ status }}&tab=event">{{ num }}</a></li>
                  {% endif %}
                {% endfor %}
                {% if event_requests.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?event_page={{ event_requests.next_page_number }}&q={{ query }}&status={{ status }}&tab=event">Next</a>
                </li>
                {% endif %}
              </ul>
            </nav>
            {% endif %}
          </div>
          <!-- Operation Requests Tab -->
          <div class="tab-pane fade {% if active_tab == 'operation' %}show active{% endif %}"
               id="operation" role="tabpanel" aria-labelledby="operation-tab">
            <div class="table-responsive">
              <table class="table table-bordered table-striped" id="operationTable">
                <thead class="table-dark">
                  <tr>
                    <th>Requested By</th>
                    <th>Operation</th>
                    <th>Category</th>
                    <th>Amount</th>
                    <th>Description</th>
                    <th>Date Requested</th>
                    <th>Status</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  {% for expense in operation_requests %}
                  <tr data-status="{% if expense.approved %}approved{% elif expense.declined %}rejected{% else %}pending{% endif %}"
                      data-expense-id="{{ expense.id }}"
                      data-search="{{ expense.created_by.get_full_name|lower }} {{ expense.operation.name|default:'general operation'|lower }} {{ expense.expense_category.name|lower }} {{ expense.description|lower }}"
                      data-batch-disbursement="{{ expense.batch_disbursement_type }}">
                    <td data-label="Requested By">
                      <div class="d-flex align-items-center">
                        <div>
                          <strong>{{ expense.created_by.get_full_name }}</strong>
                          <br>
                          <small class="text-muted">{{ expense.created_by.email }}</small>
                        </div>
                      </div>
                    </td>
                    <td data-label="Operation">
                      {% if expense.operation %}
                      <strong>{{ expense.operation.name }}</strong>
                      {% else %}
                      <span class="text-muted">General Operation</span>
                      {% endif %}
                    </td>
                    <td data-label="Category">
                      <span class="badge bg-secondary">{{ expense.expense_category.name }}</span>
                    </td>
                    <td data-label="Amount">
                      <strong>KSH {{ expense.amount|floatformat:2|intcomma }}</strong>
                    </td>
                    <td data-label="Description">
                      <div class="description-cell">
                        {{ expense.description|truncatewords:10 }}
                        {% if expense.description|length > 50 %}
                        <br>
                        <small>
                          <a href="#" class="text-primary view-full-description"
                             data-full-description="{{ expense.description }}">View full description</a>
                        </small>
                        {% endif %}
                      </div>
                    </td>
                    <td data-label="Date Requested">
                      <small>{{ expense.created_at|date:"M d, Y" }}<br>{{ expense.created_at|time:"g:i A" }}</small>
                    </td>
                    <td data-label="Status">
                      {% if expense.approved %}
                        <span class="badge bg-success">Approved</span>
                        {% if expense.approved_by %}
                        <br><small class="text-muted">by {{ expense.approved_by.get_full_name }}</small>
                        {% endif %}
                      {% elif expense.declined %}
                        <span class="badge bg-danger">Rejected</span>
                        {% if expense.decline_reason %}
                        <br><small class="text-muted view-decline-reason"
                                   data-full-reason="{{ expense.decline_reason }}">
                          Reason: {{ expense.decline_reason|truncatewords:3 }}
                        </small>
                        {% endif %}
                      {% else %}
                        <span class="badge bg-warning text-dark">Pending</span>
                      {% endif %}
                    </td>
                    <td data-label="Action">
                      {% if not expense.approved and not expense.declined %}
                      <div class="btn-group-vertical" role="group">
                        <button class="btn btn-success btn-sm approve-btn"
                                data-bs-toggle="modal" data-bs-target="#approveModal"
                                data-expense-id="{{ expense.id }}"
                                data-expense-type="operation"
                                data-requester="{{ expense.created_by.get_full_name }}"
                                data-amount="KSH {{ expense.amount|floatformat:2|intcomma }}"
                                data-description="{{ expense.description }}"
                                data-item-name="{% if expense.operation %}{{ expense.operation.name }}{% else %}General Operation{% endif %}"
                                data-batch-disbursement="{{ expense.batch_disbursement_type }}">
                            Approve
                        </button>
                        <button class="btn btn-danger btn-sm reject-btn"
                                data-bs-toggle="modal" data-bs-target="#rejectModal"
                                data-expense-id="{{ expense.id }}"
                                data-expense-type="operation"
                                data-requester="{{ expense.created_by.get_full_name }}"
                                data-amount="KSH {{ expense.amount|floatformat:2|intcomma }}"
                                data-description="{{ expense.description }}"
                                data-item-name="{% if expense.operation %}{{ expense.operation.name }}{% else %}General Operation{% endif %}">
                            Reject
                        </button>
                      </div>
                      {% else %}
                      <button class="btn btn-warning btn-sm undo-btn"
                              data-bs-toggle="modal" data-bs-target="#undoModal"
                              data-expense-id="{{ expense.id }}"
                              data-expense-type="operation"
                              data-requester="{{ expense.created_by.get_full_name }}"
                              data-amount="KSH {{ expense.amount|floatformat:2|intcomma }}"
                              data-description="{{ expense.description }}"
                              data-item-name="{% if expense.operation %}{{ expense.operation.name }}{% else %}General Operation{% endif %}"
                              data-status="{% if expense.approved %}approved{% else %}rejected{% endif %}">
                        Undo
                      </button>
                      {% endif %}
                    </td>
                  </tr>
                  {% empty %}
                  <tr class="no-results">
                    <td colspan="8" class="text-center py-4">
                      <div class="empty-state">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5>No operation requests found</h5>
                        <p class="text-muted">
                          {% if query %}
                          No requests match your search criteria.
                          {% else %}
                          There are no operation expense requests at the moment.
                          {% endif %}
                        </p>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <!-- Operation Pagination -->
            {% if operation_requests.has_other_pages %}
            <nav aria-label="Operation requests pagination">
              <ul class="pagination justify-content-center">
                {% if operation_requests.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?op_page={{ operation_requests.previous_page_number }}&q={{ query }}&status={{ status }}&tab=operation">Previous</a>
                </li>
                {% endif %}
                {% for num in operation_requests.paginator.page_range %}
                  {% if operation_requests.number == num %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                  {% elif num > operation_requests.number|add:'-3' and num < operation_requests.number|add:'3' %}
                    <li class="page-item"><a class="page-link" href="?op_page={{ num }}&q={{ query }}&status={{ status }}&tab=operation">{{ num }}</a></li>
                  {% endif %}
                {% endfor %}
                {% if operation_requests.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?op_page={{ operation_requests.next_page_number }}&q={{ query }}&status={{ status }}&tab=operation">Next</a>
                </li>
                {% endif %}
              </ul>
            </nav>
            {% endif %}
          </div>
          <!-- Request History Tab -->
          <div class="tab-pane fade {% if active_tab == 'history' %}show active{% endif %}"
               id="history" role="tabpanel" aria-labelledby="history-tab">
            <div class="table-responsive">
              <table class="table table-bordered table-striped" id="historyTable">
                <thead class="table-dark">
                  <tr>
                    <th>Requested By</th>
                    <th>Type</th>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Amount</th>
                    <th>Description</th>
                    <th>Status</th>
                    <th>Processed By</th>
                    <th>Date Processed</th>
                    <!-- <th>Action</th> -->
                  </tr>
                </thead>
                <tbody>
                  {% for expense in past_requests %}
                  <tr data-status="{% if expense.approved %}approved{% elif expense.declined %}rejected{% else %}pending{% endif %}"
                      data-expense-id="{{ expense.id }}"
                      data-search="{{ expense.created_by.get_full_name|lower }} {% if expense.event %}{{ expense.event.name|lower }}{% elif expense.activation %}{{ expense.activation.name|lower }}{% else %}{{ expense.operation.name|default:'general operation'|lower }}{% endif %} {{ expense.expense_category.name|lower }} {{ expense.description|lower }}"
                      data-batch-disbursement="{{ expense.batch_disbursement_type }}">
                    <td data-label="Requested By">
                      <div class="d-flex align-items-center">
                        <div>
                          <strong>{{ expense.created_by.get_full_name }}</strong>
                          <br>
                          <small class="text-muted">{{ expense.created_by.email }}</small>
                        </div>
                      </div>
                    </td>
                    <td data-label="Type">
                      {% if expense.event %}
                        <span class="badge bg-info">Event</span>
                      {% elif expense.activation %}
                        <span class="badge bg-primary">Activation</span>
                      {% else %}
                        <span class="badge bg-secondary">Operation</span>
                      {% endif %}
                    </td>
                    <td data-label="Name">
                      {% if expense.event %}
                        <strong>{{ expense.event.name }}</strong>
                      {% elif expense.activation %}
                        <strong>{{ expense.activation.name }}</strong>
                        <br>
                        <small class="text-muted">{{ expense.activation.category.name }}</small>
                      {% else %}
                        <strong>{{ expense.operation.name|default:"General Operation" }}</strong>
                      {% endif %}
                    </td>
                    <td data-label="Category">{{ expense.expense_category.name }}</td>
                    <td data-label="Amount"><strong>KSH {{ expense.amount|floatformat:2|intcomma }}</strong></td>
                    <td data-label="Description">
                      {{ expense.description|truncatewords:8 }}
                      {% if expense.description|length > 40 %}
                      <br>
                      <small>
                        <a href="#" class="text-primary view-full-description"
                           data-full-description="{{ expense.description }}">View full</a>
                      </small>
                      {% endif %}
                    </td>
                    <td data-label="Status">
                      {% if expense.approved %}
                        <span class="badge bg-success">Approved</span>
                      {% elif expense.declined %}
                        <span class="badge bg-danger">Rejected</span>
                        {% if expense.decline_reason %}
                        <br>
                        <small class="text-muted view-decline-reason"
                               data-full-reason="{{ expense.decline_reason }}">
                          Reason: {{ expense.decline_reason|truncatewords:3 }}
                        </small>
                        {% endif %}
                      {% else %}
                        <span class="badge bg-warning text-dark">Pending</span>
                      {% endif %}
                    </td>
                    <td data-label="Processed By">
                      {% if expense.approved_by %}
                      {{ expense.approved_by.get_full_name }}
                      {% else %}
                      <span class="text-muted">—</span>
                      {% endif %}
                    </td>
                    <td data-label="Date Processed">
                      <small>{{ expense.updated_at|date:"M d, Y" }}<br>{{ expense.updated_at|time:"g:i A" }}</small>
                    </td>
                    <!-- <td>
                      <button class="btn btn-warning btn-sm undo-btn"
                              data-bs-toggle="modal" data-bs-target="#undoModal"
                              data-expense-id="{{ expense.id }}"
                              data-expense-type="{% if expense.event %}event{% elif expense.activation %}activation{% else %}operation{% endif %}"
                              data-requester="{{ expense.created_by.get_full_name }}"
                              data-amount="KSH {{ expense.amount|floatformat:2|intcomma }}"
                              data-description="{{ expense.description }}"
                              data-item-name="{% if expense.event %}{{ expense.event.name }}{% elif expense.activation %}{{ expense.activation.name }}{% else %}{{ expense.operation.name|default:'General Operation' }}{% endif %}"
                              data-status="{% if expense.approved %}approved{% else %}rejected{% endif %}">
                        Undo
                      </button>
                    </td> -->
                  </tr>
                  {% empty %}
                  <tr class="no-results">
                    <td colspan="10" class="text-center py-4">
                      <div class="empty-state">
                        <i class="fas fa-history fa-3x text-muted mb-3"></i>
                        <h5>No request history found</h5>
                        <p class="text-muted">
                          {% if query %}
                          No processed requests match your search criteria.
                          {% else %}
                          There are no processed requests at the moment.
                          {% endif %}
                        </p>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <!-- History Pagination -->
            {% if past_requests.has_other_pages %}
            <nav aria-label="Request history pagination">
              <ul class="pagination justify-content-center">
                {% if past_requests.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?history_page={{ past_requests.previous_page_number }}&q={{ query }}&status={{ status }}&tab=history">Previous</a>
                </li>
                {% endif %}
                {% for num in past_requests.paginator.page_range %}
                  {% if past_requests.number == num %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                  {% elif num > past_requests.number|add:'-3' and num < past_requests.number|add:'3' %}
                    <li class="page-item"><a class="page-link" href="?history_page={{ num }}&q={{ query }}&status={{ status }}&tab=history">{{ num }}</a></li>
                  {% endif %}
                {% endfor %}
                {% if past_requests.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?history_page={{ past_requests.next_page_number }}&q={{ query }}&status={{ status }}&tab=history">Next</a>
                </li>
                {% endif %}
              </ul>
            </nav>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<!-- Approve Confirmation Modal -->
<div class="modal fade" id="approveModal" tabindex="-1" aria-labelledby="approveModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="approveModalLabel">
          <i class="fas fa-check-circle text-success"></i> Confirm Approval
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="approveForm" method="POST">
        <div class="modal-body">
          {% csrf_token %}
          <div class="alert alert-info">
            <strong>Request Details:</strong>
          </div>
          <div class="row">
            <div class="col-sm-4"><strong>Requester:</strong></div>
            <div class="col-sm-8" id="approve-requester">—</div>
          </div>
          <div class="row mt-2">
            <div class="col-sm-4"><strong>Expense For:</strong></div>
            <div class="col-sm-8" id="approve-item-name">—</div>
          </div>
          <div class="row mt-2">
            <div class="col-sm-4"><strong>Type:</strong></div>
            <div class="col-sm-8" id="approve-type">—</div>
          </div>
          <div class="row mt-2">
            <div class="col-sm-4"><strong>Amount:</strong></div>
            <div class="col-sm-8" id="approve-amount">—</div>
          </div>
          <div class="row mt-2">
            <div class="col-sm-4"><strong>Description:</strong></div>
            <div class="col-sm-8" id="approve-description">—</div>
          </div>
          <!-- CSV Preview Section -->
          <div class="row mt-3">
            <div class="col-12">
              <div id="csv-preview-section" class="d-none">
                <h6 class="text-primary"><i class="fas fa-file-csv"></i> Batch Disbursement CSV Preview (Name, Amount, Mobile, ID Number)</h6>
                <div id="csv-preview-loading" class="text-center py-3 d-none">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <p class="mt-2">Loading CSV preview...</p>
                </div>
                <div id="csv-preview-content" class="table-responsive"></div>
                <div id="csv-preview-error" class="alert alert-danger d-none mt-2"></div>
              </div>
              <div id="no-csv-message" class="text-muted small">
                No CSV file attached to this batch disbursement.
              </div>
            </div>
          </div>
          <hr>
          <p class="text-center mb-0">Are you sure you want to <strong class="text-success">approve</strong> this expense request?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success" id="confirmApprove">
            <i class="fas fa-check"></i> Approve Request
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
<!-- Reject Reason Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="rejectModalLabel">
          <i class="fas fa-times-circle text-danger"></i> Reject Request
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="rejectForm" method="POST">
        <div class="modal-body">
          {% csrf_token %}
          <div class="alert alert-warning">
            <strong>Request Details:</strong>
          </div>
          <div class="row">
            <div class="col-sm-4"><strong>Requester:</strong></div>
            <div class="col-sm-8" id="reject-requester">—</div>
          </div>
          <div class="row mt-2">
            <div class="col-sm-4"><strong>Expense For:</strong></div>
            <div class="col-sm-8" id="reject-item-name">—</div>
          </div>
          <div class="row mt-2">
            <div class="col-sm-4"><strong>Type:</strong></div>
            <div class="col-sm-8" id="reject-type">—</div>
          </div>
          <div class="row mt-2">
            <div class="col-sm-4"><strong>Amount:</strong></div>
            <div class="col-sm-8" id="reject-amount">—</div>
          </div>
          <div class="row mt-2">
            <div class="col-sm-4"><strong>Description:</strong></div>
            <div class="col-sm-8" id="reject-description">—</div>
          </div>
          <hr>
          <div class="mb-3">
            <label for="declineReason" class="form-label">Reason for Rejection:</label>
            <textarea class="form-control" id="declineReason" name="reason" rows="3" placeholder="Please provide a reason for rejecting this request (required)."></textarea>
            <div class="invalid-feedback">
              Rejection reason cannot be empty.
            </div>
          </div>
          <p class="text-center mb-0">Are you sure you want to <strong class="text-danger">reject</strong> this expense request?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger" id="confirmReject">
            <i class="fas fa-times"></i> Reject Request
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
<!-- Undo Confirmation Modal -->
<div class="modal fade" id="undoModal" tabindex="-1" aria-labelledby="undoModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="undoModalLabel">
          <i class="fas fa-undo text-warning"></i> Confirm Undo Action
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="undoForm" method="POST">
        <div class="modal-body">
          {% csrf_token %}
          <div class="alert alert-warning">
            <strong>Request Details:</strong>
          </div>
          <div class="row">
            <div class="col-sm-4"><strong>Requester:</strong></div>
            <div class="col-sm-8" id="undo-requester">—</div>
          </div>
          <div class="row mt-2">
            <div class="col-sm-4"><strong>Expense For:</strong></div>
            <div class="col-sm-8" id="undo-item-name">—</div>
          </div>
          <div class="row mt-2">
            <div class="col-sm-4"><strong>Type:</strong></div>
            <div class="col-sm-8" id="undo-type">—</div>
          </div>
          <div class="row mt-2">
            <div class="col-sm-4"><strong>Amount:</strong></div>
            <div class="col-sm-8" id="undo-amount">—</div>
          </div>
          <div class="row mt-2">
            <div class="col-sm-4"><strong>Description:</strong></div>
            <div class="col-sm-8" id="undo-description">—</div>
          </div>
          <div class="row mt-2">
            <div class="col-sm-4"><strong>Current Status:</strong></div>
            <div class="col-sm-8" id="undo-status">—</div>
          </div>
          <hr>
          <p class="text-center mb-0">Are you sure you want to <strong class="text-warning">undo</strong> this expense action and revert it to pending?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning" id="confirmUndo">
            <i class="fas fa-undo"></i> Undo Action
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap Tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    /**
     * Retrieves the CSRF token from a meta tag or a hidden input.
     */
    function getCsrfToken() {
        const metaTag = document.querySelector('meta[name="csrf-token"]');
        if (metaTag) {
            return metaTag.getAttribute('content');
        }
        const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
        if (csrfInput) {
            return csrfInput.value;
        }
        return null;
    }
    /**
     * Displays a custom message box instead of alert/confirm.
     */
    function showMessageBox(title, message, type = 'info') {
        const modalId = 'messageBoxModal';
        let modalElement = document.getElementById(modalId);
        if (!modalElement) {
            modalElement = document.createElement('div');
            modalElement.id = modalId;
            modalElement.classList.add('modal', 'fade');
            modalElement.setAttribute('tabindex', '-1');
            modalElement.setAttribute('aria-labelledby', modalId + 'Label');
            modalElement.setAttribute('aria-hidden', 'true');
            modalElement.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="${modalId}Label"></h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body"></div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modalElement);
        }
        const modalTitle = modalElement.querySelector('.modal-title');
        const modalBody = modalElement.querySelector('.modal-body');
        modalTitle.textContent = title;
        if (type) {
            modalTitle.className = `modal-title text-${type}`;
        }
        modalBody.innerHTML = message;
        const bsModal = new bootstrap.Modal(modalElement);
        bsModal.show();
    }
    // Get references to relevant DOM elements
    const filterForm = document.getElementById('filterForm');
    const statusFilterButtons = document.querySelectorAll('.btn-group button[data-filter]');
    const searchInput = document.getElementById('searchInput');
    // --- Event Listeners ---
    // Tab switching listener (intercept Bootstrap tab show and submit form)
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tabElement => {
        tabElement.addEventListener('show.bs.tab', function(event) {
            event.preventDefault(); // Prevent client-side tab switch
            const newTab = this.dataset.tab;
            const defaultStatus = (newTab === 'activation') ? 'pending' : 'all';
            document.getElementById('tabFilter').value = newTab;
            document.getElementById('statusFilter').value = defaultStatus;
            document.getElementById('searchInput').value = ''; // Reset search on tab change
            filterForm.submit();
        });
    });
    // Status filter button listener (submit form on click)
    statusFilterButtons.forEach(button => {
        button.addEventListener('click', function() {
            const newStatus = this.dataset.filter;
            document.getElementById('statusFilter').value = newStatus;
            filterForm.submit();
        });
    });
    // Search input listener (submit form after typing timeout)
    let searchTimeout;
    searchInput.addEventListener('keyup', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            filterForm.submit();
        }, 500);
    });
    // --- Modal Functionality ---
    // Helper function to reload page with current URL parameters
    function reloadWithCurrentParams() {
        window.location.reload();
    }
    // Function to load CSV preview
    async function loadCsvPreview(expenseId) {
        const modal = document.getElementById('approveModal');
        if (!modal) return;
        const previewSection = modal.querySelector('#csv-preview-section');
        const loadingEl = modal.querySelector('#csv-preview-loading');
        const contentEl = modal.querySelector('#csv-preview-content');
        const errorEl = modal.querySelector('#csv-preview-error');
        if (!previewSection || !loadingEl || !contentEl || !errorEl) {
            console.error('CSV preview elements not found in modal');
            return;
        }
        // Reset
        contentEl.innerHTML = '';
        errorEl.classList.add('d-none');
        loadingEl.classList.remove('d-none');
        try {
            const response = await fetch(`/expense/${expenseId}/csv-preview/`);
            const data = await response.json();
            loadingEl.classList.add('d-none');
            if (response.ok && data.success) {
                contentEl.innerHTML = data.html;
                previewSection.classList.remove('d-none');
            } else {
                errorEl.textContent = data.error || 'Failed to load CSV preview.';
                errorEl.classList.remove('d-none');
                previewSection.classList.remove('d-none');
            }
        } catch (error) {
            loadingEl.classList.add('d-none');
            errorEl.textContent = 'An error occurred while loading the CSV preview.';
            errorEl.classList.remove('d-none');
            previewSection.classList.remove('d-none');
        }
    }
    // Approve Modal
    const approveModal = document.getElementById('approveModal');
    if (approveModal) {
        approveModal.addEventListener('show.bs.modal', async function (event) {
            const button = event.relatedTarget;
            const expenseId = button.dataset.expenseId;
            const expenseType = button.dataset.expenseType;
            const requester = button.dataset.requester;
            const amount = button.dataset.amount;
            const description = button.dataset.description;
            const itemName = button.dataset.itemName;
            const isBatchDisbursement = button.dataset.batchDisbursement === 'True';
            const approveRequester = approveModal.querySelector('#approve-requester');
            const approveItemName = approveModal.querySelector('#approve-item-name');
            const approveType = approveModal.querySelector('#approve-type');
            const approveAmount = approveModal.querySelector('#approve-amount');
            const approveDescription = approveModal.querySelector('#approve-description');
            if (approveRequester) approveRequester.textContent = requester;
            if (approveItemName) approveItemName.textContent = itemName;
            if (approveType) approveType.textContent = expenseType.charAt(0).toUpperCase() + expenseType.slice(1) + ' Expense';
            if (approveAmount) approveAmount.textContent = amount;
            if (approveDescription) approveDescription.textContent = description;
            const approveForm = approveModal.querySelector('#approveForm');
            if (approveForm) approveForm.action = `/expense/${expenseId}/approve/`;
            const previewSection = approveModal.querySelector('#csv-preview-section');
            const noCsvEl = approveModal.querySelector('#no-csv-message');
            if (previewSection && noCsvEl) {
                if (isBatchDisbursement) {
                    noCsvEl.classList.add('d-none');
                    await loadCsvPreview(expenseId);
                } else {
                    previewSection.classList.add('d-none');
                    noCsvEl.textContent = 'This is not a batch disbursement expense.';
                    noCsvEl.classList.remove('d-none');
                }
            }
        });
        const approveForm = document.getElementById('approveForm');
        if (approveForm) {
            approveForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                const form = event.target;
                const expenseIdMatch = form.action.match(/expense\/([0-9a-f-]+)\/approve\//);
                if (!expenseIdMatch) return;
                const expenseId = expenseIdMatch[1];
                const csrfToken = form.querySelector('input[name="csrfmiddlewaretoken"]');
                if (!csrfToken) return;
                const expenseType = form.querySelector('#approve-type');
                if (!expenseType) return;
                const expenseTypeStr = expenseType.textContent.toLowerCase().replace(' expense', '');
                const modalInstance = bootstrap.Modal.getInstance(approveModal);
                if (modalInstance) modalInstance.hide();
                try {
                    const response = await fetch(form.action, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken.value
                        },
                        body: new FormData(form)
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showMessageBox('Success', data.message, 'success');
                        updateTableRowStatus(expenseId, expenseTypeStr, 'approved', data.approved_by_name);
                        setTimeout(() => {
                            if (confirm('Expense approved. Would you like to refresh the page to see the latest updates?')) {
                                reloadWithCurrentParams();
                            }
                        }, 1000);
                    } else {
                        showMessageBox('Error', data.error || 'Failed to approve expense request.', 'danger');
                    }
                } catch (error) {
                    showMessageBox('Error', 'An unexpected error occurred during approval. Please try again.', 'danger');
                }
            });
        }
    }
    // Reject Modal
    const rejectModal = document.getElementById('rejectModal');
    if (rejectModal) {
        rejectModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const expenseId = button.dataset.expenseId;
            const expenseType = button.dataset.expenseType;
            const requester = button.dataset.requester;
            const amount = button.dataset.amount;
            const description = button.dataset.description;
            const itemName = button.dataset.itemName;
            const rejectRequester = rejectModal.querySelector('#reject-requester');
            const rejectItemName = rejectModal.querySelector('#reject-item-name');
            const rejectType = rejectModal.querySelector('#reject-type');
            const rejectAmount = rejectModal.querySelector('#reject-amount');
            const rejectDescription = rejectModal.querySelector('#reject-description');
            if (rejectRequester) rejectRequester.textContent = requester;
            if (rejectItemName) rejectItemName.textContent = itemName;
            if (rejectType) rejectType.textContent = expenseType.charAt(0).toUpperCase() + expenseType.slice(1) + ' Expense';
            if (rejectAmount) rejectAmount.textContent = amount;
            if (rejectDescription) rejectDescription.textContent = description;
            const rejectForm = rejectModal.querySelector('#rejectForm');
            if (rejectForm) rejectForm.action = `/expense/${expenseId}/decline/`;
            const declineReasonInput = rejectModal.querySelector('#declineReason');
            if (declineReasonInput) {
                declineReasonInput.value = '';
                declineReasonInput.classList.remove('is-invalid');
            }
        });
        const rejectForm = document.getElementById('rejectForm');
        if (rejectForm) {
            rejectForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                const form = event.target;
                const expenseIdMatch = form.action.match(/expense\/([0-9a-f-]+)\/decline\//);
                if (!expenseIdMatch) return;
                const expenseId = expenseIdMatch[1];
                const declineReasonInput = form.querySelector('#declineReason');
                if (!declineReasonInput) return;
                const declineReason = declineReasonInput.value.trim();
                const csrfToken = form.querySelector('input[name="csrfmiddlewaretoken"]');
                if (!csrfToken) return;
                const rejectType = form.querySelector('#reject-type');
                if (!rejectType) return;
                const expenseTypeStr = rejectType.textContent.toLowerCase().replace(' expense', '');
                if (!declineReason) {
                    if (declineReasonInput) declineReasonInput.classList.add('is-invalid');
                    return;
                } else {
                    if (declineReasonInput) declineReasonInput.classList.remove('is-invalid');
                }
                const modalInstance = bootstrap.Modal.getInstance(rejectModal);
                if (modalInstance) modalInstance.hide();
                try {
                    const formData = new FormData(form);
                    formData.set('reason', declineReason);
                    const response = await fetch(form.action, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken.value
                        },
                        body: formData
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showMessageBox('Success', data.message, 'success');
                        updateTableRowStatus(expenseId, expenseTypeStr, 'rejected', null, declineReason);
                        setTimeout(() => {
                            if (confirm('Expense rejected. Would you like to refresh the page to see the latest updates?')) {
                                reloadWithCurrentParams();
                            }
                        }, 1000);
                    } else {
                        showMessageBox('Error', data.error || 'Failed to reject expense request.', 'danger');
                    }
                } catch (error) {
                    showMessageBox('Error', 'An unexpected error occurred during rejection. Please try again.', 'danger');
                }
            });
        }
    }
    // Undo Modal
    const undoModal = document.getElementById('undoModal');
    if (undoModal) {
        undoModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const expenseId = button.dataset.expenseId;
            const expenseType = button.dataset.expenseType;
            const requester = button.dataset.requester;
            const amount = button.dataset.amount;
            const description = button.dataset.description;
            const itemName = button.dataset.itemName;
            const status = button.dataset.status;
            const undoRequester = undoModal.querySelector('#undo-requester');
            const undoItemName = undoModal.querySelector('#undo-item-name');
            const undoType = undoModal.querySelector('#undo-type');
            const undoAmount = undoModal.querySelector('#undo-amount');
            const undoDescription = undoModal.querySelector('#undo-description');
            const undoStatus = undoModal.querySelector('#undo-status');
            if (undoRequester) undoRequester.textContent = requester;
            if (undoItemName) undoItemName.textContent = itemName;
            if (undoType) undoType.textContent = expenseType.charAt(0).toUpperCase() + expenseType.slice(1) + ' Expense';
            if (undoAmount) undoAmount.textContent = amount;
            if (undoDescription) undoDescription.textContent = description;
            if (undoStatus) undoStatus.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            const undoForm = undoModal.querySelector('#undoForm');
            if (undoForm) undoForm.action = `/expense/${expenseId}/undo/`;
        });
        const undoForm = document.getElementById('undoForm');
        if (undoForm) {
            undoForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                const form = event.target;
                const expenseIdMatch = form.action.match(/expense\/([0-9a-f-]+)\/undo\//);
                if (!expenseIdMatch) return;
                const expenseId = expenseIdMatch[1];
                const csrfToken = form.querySelector('input[name="csrfmiddlewaretoken"]');
                if (!csrfToken) return;
                const undoType = form.querySelector('#undo-type');
                if (!undoType) return;
                const expenseTypeStr = undoType.textContent.toLowerCase().replace(' expense', '');
                const modalInstance = bootstrap.Modal.getInstance(undoModal);
                if (modalInstance) modalInstance.hide();
                try {
                    const response = await fetch(form.action, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken.value
                        },
                        body: new FormData(form)
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showMessageBox('Success', data.message, 'success');
                        updateTableRowStatus(expenseId, expenseTypeStr, 'pending', '');
                        setTimeout(() => {
                            if (confirm('Expense action undone. Would you like to refresh the page to see the latest updates?')) {
                                reloadWithCurrentParams();
                            }
                        }, 1000);
                    } else {
                        showMessageBox('Error', data.error || 'Failed to undo expense action.', 'danger');
                    }
                } catch (error) {
                    showMessageBox('Error', 'An unexpected error occurred during undo. Please try again.', 'danger');
                }
            });
        }
    }
    /**
     * Updates the status of a specific table row after approval/rejection/undo.
     */
    function updateTableRowStatus(expenseId, expenseType, newStatus, processedByName, declineReason = '') {
        let tableId;
        if (expenseType === 'event') {
            tableId = 'eventTable';
        } else if (expenseType === 'operation') {
            tableId = 'operationTable';
        } else {
            tableId = 'activationTable';
        }
        const table = document.getElementById(tableId);
        if (!table) return;
        const row = table.querySelector(`tr[data-expense-id="${expenseId}"]`);
        if (!row) return;
        row.dataset.status = newStatus;
        let statusCellIndex = -1;
        if (tableId === 'eventTable') {
            statusCellIndex = 7;
        } else if (tableId === 'operationTable') {
            statusCellIndex = 6;
        } else if (tableId === 'activationTable') {
            statusCellIndex = -1; // No status column
        }
        let actionCellIndex = 7; // Default
        if (tableId === 'historyTable') {
            actionCellIndex = 9;
        } else if (tableId === 'eventTable') {
            actionCellIndex = 8;
        } else if (tableId === 'operationTable') {
            actionCellIndex = 7;
        } else if (tableId === 'activationTable') {
            actionCellIndex = 7;
        }
        if (statusCellIndex !== -1) {
            const statusCell = row.cells[statusCellIndex];
            if (statusCell) {
                let statusHtml = '';
                if (newStatus === 'approved') {
                    statusHtml = `<span class="badge bg-success">Approved</span>`;
                    if (processedByName) {
                        statusHtml += `<br><small class="text-muted">by ${processedByName}</small>`;
                    }
                } else if (newStatus === 'rejected') {
                    statusHtml = `<span class="badge bg-danger">Rejected</span>`;
                    if (declineReason) {
                        const displayedReason = declineReason.length > 20 ? declineReason.substring(0, 17) + '...' : declineReason;
                        statusHtml += `<br><small class="text-muted view-decline-reason" data-full-reason="${declineReason}">Reason: ${displayedReason}</small>`;
                    }
                } else {
                    statusHtml = `<span class="badge bg-warning text-dark">Pending</span>`;
                }
                statusCell.innerHTML = statusHtml;
            }
        }
        const actionCell = row.cells[actionCellIndex];
        if (actionCell) {
            let actionHtml = '';
            if (newStatus === 'pending') {
                const requester = row.querySelector('td:first-child strong');
                const requesterName = requester ? requester.textContent.trim() : '';
                let amountCellIndex = 3;
                if (tableId === 'activationTable') amountCellIndex = 4;
                const amount = row.cells[amountCellIndex] ? row.cells[amountCellIndex].textContent.trim() : '';
                const descriptionCell = row.querySelector('.description-cell');
                const description = descriptionCell ? descriptionCell.textContent.trim() : '';
                let itemNameCellIndex = 1;
                if (tableId === 'activationTable') itemNameCellIndex = 2;
                const itemNameEl = row.cells[itemNameCellIndex].querySelector('strong');
                const itemName = itemNameEl ? itemNameEl.textContent.trim() : (tableId === 'operationTable' ? 'General Operation' : '—');
                const batchDisbursement = row.dataset.batchDisbursement || 'False';
                actionHtml = `
                    <div class="btn-group-vertical" role="group">
                        <button class="btn btn-success btn-sm approve-btn"
                                data-bs-toggle="modal" data-bs-target="#approveModal"
                                data-expense-id="${expenseId}"
                                data-expense-type="${expenseType}"
                                data-requester="${requesterName}"
                                data-amount="${amount}"
                                data-description="${description}"
                                data-item-name="${itemName}"
                                data-batch-disbursement="${batchDisbursement}">
                            Approve
                        </button>
                        <button class="btn btn-danger btn-sm reject-btn"
                                data-bs-toggle="modal" data-bs-target="#rejectModal"
                                data-expense-id="${expenseId}"
                                data-expense-type="${expenseType}"
                                data-requester="${requesterName}"
                                data-amount="${amount}"
                                data-description="${description}"
                                data-item-name="${itemName}">
                            Reject
                        </button>
                    </div>`;
            } else {
                const requester = row.querySelector('td:first-child strong');
                const requesterName = requester ? requester.textContent.trim() : '';
                let amountCellIndex = 3;
                if (tableId === 'activationTable') amountCellIndex = 4;
                const amount = row.cells[amountCellIndex] ? row.cells[amountCellIndex].textContent.trim() : '';
                const descriptionCell = row.querySelector('.description-cell');
                const description = descriptionCell ? descriptionCell.textContent.trim() : '';
                let itemNameCellIndex = 1;
                if (tableId === 'activationTable') itemNameCellIndex = 2;
                const itemNameEl = row.cells[itemNameCellIndex].querySelector('strong');
                const itemName = itemNameEl ? itemNameEl.textContent.trim() : (tableId === 'operationTable' ? 'General Operation' : '—');
                actionHtml = `
                    <button class="btn btn-warning btn-sm undo-btn"
                            data-bs-toggle="modal" data-bs-target="#undoModal"
                            data-expense-id="${expenseId}"
                            data-expense-type="${expenseType}"
                            data-requester="${requesterName}"
                            data-amount="${amount}"
                            data-description="${description}"
                            data-item-name="${itemName}"
                            data-status="${newStatus}">
                        Undo
                    </button>`;
            }
            actionCell.innerHTML = actionHtml;
        }
        // Hide row if new status doesn't match current filter (to maintain consistency until reload)
        const currentStatus = new URLSearchParams(window.location.search).get('status') || 'all';
        if (currentStatus !== 'all' && newStatus !== currentStatus) {
            row.style.display = 'none';
        }
    }
    // --- Export Functionality ---
    document.querySelectorAll('#exportDropdown .dropdown-item').forEach(item => {
        item.addEventListener('click', function(event) {
            event.preventDefault();
            const exportType = this.dataset.exportType;
            const currentSearch = window.location.search;
            const exportUrl = `/export_expenses/${currentSearch}&format=${exportType}`;
            window.location.href = exportUrl;
        });
    });
    // --- Full Description and Decline Reason Viewers ---
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('view-full-description')) {
            event.preventDefault();
            const fullDescription = event.target.dataset.fullDescription;
            showMessageBox('Full Description', fullDescription, 'info');
        } else if (event.target.classList.contains('view-decline-reason')) {
            event.preventDefault();
            const fullReason = event.target.dataset.fullReason;
            showMessageBox('Rejection Reason', fullReason, 'warning');
        }
    });
});
</script>
{% endblock %}