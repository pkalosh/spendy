{% extends "partials/dashboard-base.html" %}
{% load static %}
{% load humanize %}
{% load expense_tags %}
{% block content %}
<!-- DataTables CSS and JS for responsive table with search/export -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
<section class="dashboard-section body-collapse">
<div class="overlay pt-120">
<div class="container-fluid">
<div class="section-header" style="background-color: #98e23f; color: white; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 1rem;">
<div class="row align-items-center">
<div class="col-lg-8">
<h4 class="section-title text-white mb-0">Invoices — {{ supplier.name }}</h4>
<p class="section-subtitle mb-0 opacity-75">Manage supplier invoices and associated items.</p>
</div>
<div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
<button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#newInvoiceModal">
<i class="fas fa-plus me-2"></i>New Invoice
</button>
</div>
</div>
</div>
<div class="table-responsive mt-4">
<table class="table table-striped">
<thead>
<tr>
<th>#</th>
<th>Invoice #</th>
<th>Date Issued</th>
<th>Total Amount</th>
<th>Due Date</th>
<th>Paid</th>
<th>Items Count</th>
<th>Actions</th>
</tr>
</thead>
<tbody>
                        {% for inv in invoices %}
<tr>
<td>{{ forloop.counter }}</td>
<td>
<strong>{{ inv.invoice_number }}</strong>
                                    {% if inv.remarks %}<br><small class="text-muted">{{ inv.remarks|truncatechars:50 }}</small>{% endif %}
</td>
<td>{{ inv.date_issued|date:"M d, Y" }}</td>
<td>KES {{ inv.total_amount|intcomma }}</td>
<td>{{ inv.due_date|date:"M d, Y"|default:"-" }}</td>
<td>
                                    {% if inv.paid %}
<span class="badge bg-success">Yes ({{ inv.payment_date|date:"M d, Y" }})</span>
                                    {% else %}
<span class="badge bg-warning text-dark">No</span>
                                    {% endif %}
</td>
<td>
<span class="badge bg-info">{{ inv.invoiceitem_set.count }}</span>
                                    {% if inv.invoiceitem_set.count > 0 %}
<button class="btn btn-sm btn-outline-info ms-1" data-bs-toggle="modal" data-bs-target="#itemsModal-{{ inv.id }}">
<i class="fas fa-list me-1"></i>Manage Items
</button>
                                    {% endif %}
</td>
<td>
<div class="btn-group" role="group">
<button class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#editInvoiceModal-{{ inv.id }}">
<i class="fas fa-edit"></i>
</button>
<button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteInvoiceModal-{{ inv.id }}">
<i class="fas fa-trash"></i>
</button>
</div>
</td>
</tr>
                        {% empty %}
<tr>
<td colspan="8" class="text-center py-5">
<i class="fas fa-file-invoice fa-3x text-muted mb-3"></i>
<h5 class="text-muted">No Invoices Found</h5>
<p class="text-muted">Get started by creating your first invoice.</p>
</td>
</tr>
                        {% endfor %}
</tbody>
</table>
</div>
</div>
</div>
</section>
<!-- Items List Modal (Per Invoice) -->
{% for inv in invoices %}
    {% if inv.invoiceitem_set.exists %}
<div class="modal fade" id="itemsModal-{{ inv.id }}" tabindex="-1" aria-hidden="true">
<div class="modal-dialog modal-xl">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">
<i class="fas fa-list me-2"></i>Items for Invoice {{ inv.invoice_number }}
</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<!-- Search and Export Controls -->
<div class="d-flex justify-content-between align-items-center mb-3">
<div class="input-group" style="width: 300px;">
<span class="input-group-text"><i class="fas fa-search"></i></span>
<input type="text" class="form-control" id="searchInput-{{ inv.id }}" placeholder="Search items...">
</div>
<div class="btn-group">
<button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
<i class="fas fa-download me-1"></i>Export
</button>
<ul class="dropdown-menu">
<li><a class="dropdown-item" href="#" onclick="exportTable('itemsTable-{{ inv.id }}', 'csv')"><i class="fas fa-file-csv me-2"></i>CSV</a></li>
<li><a class="dropdown-item" href="#" onclick="exportTable('itemsTable-{{ inv.id }}', 'excel')"><i class="fas fa-file-excel me-2"></i>Excel</a></li>
<li><a class="dropdown-item" href="#" onclick="exportTable('itemsTable-{{ inv.id }}', 'pdf')"><i class="fas fa-file-pdf me-2"></i>PDF</a></li>
</ul>
</div>
<button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#newItemModal-{{ inv.id }}" data-bs-dismiss="modal">
<i class="fas fa-plus me-2"></i>New Item
</button>
</div>
<!-- Responsive Items Table -->
<div class="table-responsive">
<table id="itemsTable-{{ inv.id }}" class="table table-hover" style="width: 100%;">
<thead>
<tr>
<th>#</th>
<th>Item Name</th>
<th>Quantity</th>
<th>Unit Price</th>
<th>Line Total</th>
<th>State</th>
<th>Actions</th>
</tr>
</thead>
<tbody>
                                    {% for item in inv.invoiceitem_set.all %}
<tr>
<td>{{ forloop.counter }}</td>
<td>{{ item.name|default:"Unnamed" }}</td>
<td>{{ item.quantity }}</td>
<td>KES {{ item.unit_price|intcomma }}</td>
<td>KES {{ item.quantity|mul:item.unit_price|intcomma }}</td>
<td>{{ item.state_of_item|default:"-" }}</td>
<td>
<div class="btn-group" role="group">
<button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editItemModal-{{ item.id }}" data-bs-dismiss="modal">
<i class="fas fa-edit"></i>
</button>
<button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteItemModal-{{ item.id }}" data-bs-dismiss="modal">
<i class="fas fa-trash"></i>
</button>
</div>
</td>
</tr>
                                    {% endfor %}
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
    {% endif %}
{% endfor %}
<!-- Existing Invoice Modals (Unchanged) -->
{% for inv in invoices %}
<!-- EDIT INVOICE MODAL -->
<div class="modal fade" id="editInvoiceModal-{{ inv.id }}" tabindex="-1" aria-hidden="true">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<form method="post" action="{% url 'expense:invoice-edit' supplier.id inv.id %}">
                    {% csrf_token %}
<div class="modal-header bg-light">
<h5 class="modal-title">Edit Invoice — {{ inv.invoice_number }}</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
                        {% with form=invoice_forms|get_item:inv.id %}
<div class="row g-3">
{% for field in form %}
<div class="col-12 col-md-6">
<label class="form-label fw-bold" for="{{ field.id_for_label }}">{{ field.label }}</label>
{{ field }}
{% if field.errors %}<div class="text-danger small">{{ field.errors }}</div>{% endif %}
{% if field.help_text %}<small class="text-muted">{{ field.help_text }}</small>{% endif %}
</div>
{% endfor %}
</div>
                        {% endwith %}
</div>
<div class="modal-footer">
<button type="submit" class="btn btn-primary">Save Changes</button>
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
</div>
</form>
</div>
</div>
</div>
<!-- DELETE INVOICE MODAL -->
<div class="modal fade" id="deleteInvoiceModal-{{ inv.id }}" tabindex="-1" aria-hidden="true">
<div class="modal-dialog">
<div class="modal-content">
<form method="post" action="{% url 'expense:invoice-delete' supplier.id inv.id %}">
                    {% csrf_token %}
<div class="modal-header bg-light">
<h5 class="modal-title text-danger">Delete Invoice — {{ inv.invoice_number }}</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<div class="row g-3">
<div class="col-12">
<p class="mb-0">Are you sure? This will also delete all associated items. This action cannot be undone.</p>
</div>
</div>
</div>
<div class="modal-footer">
<button type="submit" class="btn btn-danger">Yes, Delete</button>
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
</div>
</form>
</div>
</div>
</div>
<!-- NEW ITEM MODAL (Per Invoice) -->
<div class="modal fade" id="newItemModal-{{ inv.id }}" tabindex="-1" aria-hidden="true">
<div class="modal-dialog">
<div class="modal-content">
<form method="post" action="{% url 'expense:invoice-item-create' supplier.id inv.id %}">
                    {% csrf_token %}
<div class="modal-header bg-light">
<h5 class="modal-title">Add New Item to {{ inv.invoice_number }}</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
                        {% with form=invoice_item_forms|get_item:inv.id %}
<div class="row g-3">
{% for field in form %}
<div class="col-12 col-md-6">
<label class="form-label fw-bold" for="{{ field.id_for_label }}">{{ field.label }}</label>
{{ field }}
{% if field.errors %}<div class="text-danger small">{{ field.errors }}</div>{% endif %}
{% if field.help_text %}<small class="text-muted">{{ field.help_text }}</small>{% endif %}
</div>
{% endfor %}
</div>
                        {% endwith %}
</div>
<div class="modal-footer">
<button type="submit" class="btn btn-primary">Add Item</button>
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
</div>
</form>
</div>
</div>
</div>
{% endfor %}
<!-- Item Edit/Delete Modals (Across All Items) -->
{% for inv in invoices %}
    {% for item in inv.invoiceitem_set.all %}
<!-- EDIT ITEM MODAL -->
<div class="modal fade" id="editItemModal-{{ item.id }}" tabindex="-1" aria-hidden="true">
<div class="modal-dialog">
<div class="modal-content">
<form method="post" action="{% url 'expense:invoice-item-edit' supplier.id item.invoice.id item.id %}">
                        {% csrf_token %}
<div class="modal-header bg-light">
<h5 class="modal-title">Edit Item — {{ item.name }}</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
                            {% with form=item_forms|get_item:item.id %}
<div class="row g-3">
{% for field in form %}
<div class="col-12 col-md-6">
<label class="form-label fw-bold" for="{{ field.id_for_label }}">{{ field.label }}</label>
{{ field }}
{% if field.errors %}<div class="text-danger small">{{ field.errors }}</div>{% endif %}
{% if field.help_text %}<small class="text-muted">{{ field.help_text }}</small>{% endif %}
</div>
{% endfor %}
</div>
                            {% endwith %}
</div>
<div class="modal-footer">
<button type="submit" class="btn btn-primary">Update Item</button>
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
</div>
</form>
</div>
</div>
</div>
<!-- DELETE ITEM MODAL -->
<div class="modal fade" id="deleteItemModal-{{ item.id }}" tabindex="-1" aria-hidden="true">
<div class="modal-dialog">
<div class="modal-content">
<form method="post" action="{% url 'expense:invoice-item-delete' supplier.id item.invoice.id item.id %}">
                        {% csrf_token %}
<div class="modal-header bg-light">
<h5 class="modal-title text-danger">Delete Item — {{ item.name }}</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<div class="row g-3">
<div class="col-12">
<p class="mb-0">Are you sure you want to delete this item? This action cannot be undone.</p>
</div>
</div>
</div>
<div class="modal-footer">
<button type="submit" class="btn btn-danger">Yes, Delete</button>
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
</div>
</form>
</div>
</div>
</div>
    {% endfor %}
{% endfor %}
<!-- NEW INVOICE MODAL (Existing) -->
<div class="modal fade" id="newInvoiceModal" tabindex="-1" aria-hidden="true">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<form method="post" action="{% url 'expense:invoice-create' supplier.id %}">
                {% csrf_token %}
<div class="modal-header bg-light">
<h5 class="modal-title">New Invoice — {{ supplier.name }}</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<div class="row g-3">
{% for field in new_invoice_form %}
<div class="col-12 col-md-6">
<label class="form-label fw-bold" for="{{ field.id_for_label }}">{{ field.label }}</label>
{{ field }}
{% if field.errors %}<div class="text-danger small">{{ field.errors }}</div>{% endif %}
{% if field.help_text %}<small class="text-muted">{{ field.help_text }}</small>{% endif %}
</div>
{% endfor %}
</div>
</div>
<div class="modal-footer">
<button type="submit" class="btn btn-primary">Create Invoice</button>
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
</div>
</form>
</div>
</div>
</div>
<script>
$(document).ready(function() {
// Initialize DataTables for each items table modal
$('[id^="itemsModal-"]').on('shown.bs.modal', function () {
const modalId = $(this).attr('id');
const tableId = modalId.replace('itemsModal-', 'itemsTable-');
if ($.fn.DataTable.isDataTable(`#${tableId}`)) {
$(`#${tableId}`).DataTable().destroy();
        }
$(`#${tableId}`).DataTable({
responsive: true,
pageLength: 10,
lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]],
dom: 'Bfrtip',
buttons: [
'copy', 'csv', 'excel', 'pdf', 'print'
            ],
language: {
search: "_INPUT_",
searchPlaceholder: "Search items...",
lengthMenu: "Show _MENU_ items"
            },
order: [[0, 'asc']]
        });
    });
// Search input enhancement
$('[id^="searchInput-"]').on('keyup', function() {
const tableId = $(this).attr('id').replace('searchInput-', 'itemsTable-');
$(`#${tableId}`).DataTable().search(this.value).draw();
    });
});
// Export function (basic CSV for demo; enhance with libraries if needed)
function exportTable(tableId, format) {
const table = $(`#${tableId}`).DataTable();
if (format === 'csv') {
table.button(1).trigger(); // CSV button
    } else if (format === 'excel') {
table.button(2).trigger(); // Excel
    } else if (format === 'pdf') {
table.button(3).trigger(); // PDF
    }
}
</script>
<style>
.section-header {
background: linear-gradient(135deg, #98e23f 0%, #7bb732 100%);
}
.btn-light:hover {
background-color: #fff;
border-color: #fff;
color: #000;
}
.modal-body input, .modal-body select, .modal-body textarea {
    border-radius: 0.375rem;
    border: 1px solid #ced4da;
    padding: 0.375rem 0.75rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}
.modal-body input:focus, .modal-body select:focus, .modal-body textarea:focus {
    border-color: #98e23f;
    box-shadow: 0 0 0 0.2rem rgba(152, 226, 63, 0.25);
    outline: 0;
}
</style>
{% endblock content %}