{% extends "partials/dashboard-base.html" %}
{% load static %}
{% load humanize %}
{% block content %}
<style>
:root {
--primary-color: #98e23f;
--secondary-color: #7ab82c;
--success-color: #10b981;
--warning-color: #f59e0b;
--danger-color: #ef4444;
--info-color: #06b6d4;
--light-bg: #f8fafc;
--dark-text: #1f2937;
--muted-text: #6b7280;
--border-color: #e5e7eb;
--shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
--shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
--shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
--border-radius: 12px;
--transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
body {
background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
}
.dashboard-section {
min-height: 100vh;
background: transparent;
}
.main-content {
padding: 2rem 0;
}
.card {
transition: var(--transition);
border: 1px solid var(--border-color);
background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
position: relative;
overflow: hidden;
}
.card::before {
content: '';
position: absolute;
top: 0;
left: 0;
width: 4px;
height: 100%;
background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
z-index: 1;
}
.card:hover {
transform: translateY(-4px) scale(1.02);
box-shadow: var(--shadow-lg);
border-color: var(--primary-color);
}
.section-title {
position: relative;
display: inline-block;
font-size: 1.25rem;
font-weight: 700;
color: var(--dark-text);
margin-bottom: 0.5rem;
}
.text-gradient {
background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
background-clip: text;
}
/* Button Enhancements */
.btn-primary {
background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
border: none;
border-radius: var(--border-radius);
font-weight: 600;
transition: var(--transition);
box-shadow: var(--shadow-sm);
}
.btn-primary:hover {
transform: translateY(-2px);
box-shadow: var(--shadow-md);
color: white;
}
.btn-success {
background: linear-gradient(135deg, var(--success-color), #059669);
border: none;
border-radius: var(--border-radius);
font-weight: 600;
transition: var(--transition);
box-shadow: var(--shadow-sm);
}
.btn-success:hover {
transform: translateY(-2px);
box-shadow: var(--shadow-md);
color: white;
}
/* Badge Enhancements */
.badge {
border-radius: 20px;
font-size: 0.75rem;
font-weight: 600;
text-transform: uppercase;
letter-spacing: 0.025em;
padding: 0.5rem 0.75rem;
}
.bg-success {
background: rgba(16, 185, 129, 0.1) !important;
color: var(--success-color) !important;
border: 1px solid rgba(16, 185, 129, 0.2);
}
.bg-warning {
background: rgba(245, 158, 11, 0.1) !important;
color: var(--warning-color) !important;
border: 1px solid rgba(245, 158, 11, 0.2);
}
.bg-danger {
background: rgba(239, 68, 68, 0.1) !important;
color: var(--danger-color) !important;
border: 1px solid rgba(239, 68, 68, 0.2);
}
/* Table Enhancements */
.table-responsive {
border-radius: var(--border-radius);
overflow: hidden;
box-shadow: var(--shadow-sm);
}
.table {
margin-bottom: 0;
}
.table thead th {
border-bottom: 2px solid var(--border-color);
font-weight: 600;
color: var(--dark-text);
padding: 1rem 0.75rem;
background: var(--light-bg);
}
.table tbody td {
padding: 1rem 0.75rem;
border-bottom: 1px solid #f1f5f9;
vertical-align: middle;
}
.table tbody tr:hover {
background: var(--light-bg);
transition: var(--transition);
}
.transaction-row:hover {
background-color: rgba(152, 226, 63, 0.05) !important;
}
/* Mobile Transfer Cards */
.mobile-transfer-card {
border: 1px solid var(--border-color);
border-radius: var(--border-radius);
box-shadow: var(--shadow-sm);
transition: var(--transition);
overflow: hidden;
}
.mobile-transfer-card:hover {
transform: translateY(-2px);
box-shadow: var(--shadow-md);
}
.mobile-transfer-card .card-body {
padding: 0.9rem;
}
.mobile-transfer-card .status-badge {
font-size: 0.7rem;
padding: 0.35rem 0.6rem;
}
.mobile-transfer-card .view-btn {
padding: 0.35rem 0.6rem;
font-size: 0.8rem;
min-width: 36px;
}
/* Modal Enhancements */
.modal-content {
border: none;
border-radius: var(--border-radius);
box-shadow: var(--shadow-lg);
}
.modal-header {
background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
color: white;
}
.modal-body {
background: #f8fafc;
}
</style>
<section class="dashboard-section body-collapse">
<div class="overlay pt-120">
<div class="container-fluid">
<div class="main-content">
<div class="row">
<div class="d-flex justify-content-between align-items-center flex-wrap mb-3">
<div>
<h5 class="section-title mb-0 text-gradient">{{ kyc.company_name|title }} Wallets</h5>
<p class="text-muted mb-0">View and manage your wallets, balances, and transactions.</p>
</div>
<div class="d-flex gap-2 mt-2 mt-md-0">
<button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newWalletModal">+ New Wallet</button>
<button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#sendModal">Wallet Transfer</button>
<button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#fundWalletModal">Fund Wallet</button>
</div>
</div>

<!-- Wallets Grid -->
{% for wallet in wallets %}
<div class="col-md-3 mb-4">
<div class="card h-100 shadow-sm rounded-3 border-0">
<div class="card-body d-flex flex-column justify-content-between text-center position-relative">
<div class="dropdown position-absolute" style="top: 10px; right: 10px;">
<button class="btn btn-link p-0 text-muted" type="button" data-bs-toggle="dropdown">
<i class="fas fa-ellipsis-v"></i>
</button>
<ul class="dropdown-menu dropdown-menu-end">
<li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#editWalletModal{{wallet.id}}"><i class="fas fa-edit me-2"></i>Edit</a></li>
<li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#fundWalletModal{{wallet.id}}" data-wallet-id="{{ wallet.id }}"><i class="fas fa-plus-circle me-2"></i>Fund</a></li>
</ul>
</div>
<div class="mb-3"><i class="fas fa-wallet fa-2x" style="color: var(--primary-color);"></i></div>
<h6 class="fw-bold text-uppercase text-muted mb-1">{{ wallet.wallet_name }}</h6>
<p class="fs-5 fw-semibold text-dark mb-0">{{ wallet.currency }} {{ wallet.balance|floatformat:2|intcomma }}</p>
</div>
</div>
</div>

<!-- Per-Wallet Edit Modal -->
<div class="modal fade" id="editWalletModal{{ wallet.id }}" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header text-black">
<h5 class="modal-title">Edit Wallet</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<form method="post" action="{% url 'wallet:edit_wallet' wallet.id %}">
{% csrf_token %}
<div class="modal-body">
<input type="hidden" name="wallet_id" value="{{ wallet.id }}">
<div class="mb-3">
<label class="form-label">Wallet Name</label>
<input type="text" class="form-control" name="wallet_name" value="{{ wallet.wallet_name }}" required>
</div>
<div class="mb-3">
<label class="form-label">Wallet Type</label>
<select class="form-select" name="wallet_type" required>
<option value="">Select wallet type</option>
<option value="EVENT" {% if wallet.wallet_type == "EVENT" %}selected{% endif %}>Event</option>
<option value="OPERATIONS" {% if wallet.wallet_type == "OPERATIONS" %}selected{% endif %}>Operations</option>
<option value="EMERGENCY" {% if wallet.wallet_type == "EMERGENCY" %}selected{% endif %}>Emergency</option>
</select>
</div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
<button type="submit" class="btn btn-primary">Update Wallet</button>
</div>
</form>
</div>
</div>
</div>

<!-- Per-Wallet Fund Modal -->
<div class="modal fade" id="fundWalletModal{{wallet.id}}" tabindex="-1">
<div class="modal-dialog">
<form method="POST" action="{% url 'wallet:fund-wallet' %}">
{% csrf_token %}
<div class="modal-content">
<div class="modal-header text-black">
<h5 class="modal-title">Fund Wallet Via M-Pesa</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<div class="alert alert-light border">
<h6 class="fw-bold mb-2">Wallet Details</h6>
<div class="row">
<div class="col-6">
<small class="text-muted">Wallet Name:</small>
<div class="fw-semibold">{{ wallet.wallet_name }}</div>
</div>
<div class="col-6">
<small class="text-muted">Current Balance:</small>
<div class="fw-semibold text-success">{{ wallet.currency }} {{ wallet.balance|floatformat:2|intcomma }}</div>
</div>
</div>
</div>
<input type="hidden" name="wallet_id" value="{{ wallet.id }}">
<div class="mb-3">
<label class="form-label">Mobile Number</label>
<input type="text" name="business_id" class="form-control" placeholder="Enter M-Pesa mobile number" required>
<small class="text-muted">Enter your M-Pesa registered mobile number</small>
</div>
<div class="mb-3">
<label class="form-label">Amount</label>
<input type="number" name="amount" class="form-control" placeholder="Enter amount" required min="1" step="0.01">
<small class="text-muted">Minimum amount: KES 1</small>
</div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
<button type="submit" class="btn btn-primary">Fund</button>
</div>
</div>
</form>
</div>
</div>
{% empty %}
<div class="col-12 text-center"><p>No wallets available.</p></div>
{% endfor %}

<!-- Filters Section -->
<div class="col-12 mb-4">
<div class="bg-white rounded-3 p-4 shadow-sm">
<h6 class="section-title mb-3"><i class="fa fa-filter me-2"></i>Filter Transfers</h6>
<form id="filterForm">
<div class="row g-3">
<div class="col-md-3">
<label for="userFilter" class="form-label">User/Recipient</label>
<select class="form-select" id="userFilter">
<option value="">All Users</option>
{% for user in all_users %}
<option value="{{ user.id }}">{{ user.name }}</option>
{% endfor %}
</select>
</div>
<div class="col-md-3">
<label for="dateFrom" class="form-label">From Date</label>
<input type="date" class="form-control" id="dateFrom">
</div>
<div class="col-md-3">
<label for="dateTo" class="form-label">To Date</label>
<input type="date" class="form-control" id="dateTo">
</div>
<div class="col-md-3">
<label for="statusFilter" class="form-label">Status</label>
<select class="form-select" id="statusFilter">
<option value="">All Status</option>
<option value="completed">Completed</option>
<option value="pending">Pending</option>
<option value="failed">Failed</option>
</select>
</div>
</div>
<div class="row mt-3">
<div class="col-12">
<button type="button" class="btn btn-primary me-2" onclick="applyFilters()"><i class="fa fa-search me-1"></i>Apply Filters</button>
<button type="button" class="btn btn-outline-secondary" onclick="clearFilters()"><i class="fa fa-times me-1"></i>Clear</button>
</div>
</div>
</form>
</div>
</div>

<!-- Transfers Section -->
<div class="col-12 mb-4">
<div class="bg-white rounded-3 p-4 shadow-sm">
<div class="d-flex justify-content-between align-items-center mb-4">
<h5 class="section-title mb-0">Transfers</h5>
<small class="text-muted">Showing <span id="showingFrom">1</span>-<span id="showingTo">10</span> of <span id="totalRecords">{{ transactions.count }}</span> transfers</small>
</div>

<!-- Desktop Table View -->
<div class="table-responsive d-none d-lg-block">
<table class="table align-middle">
<thead>
<tr>
<th>Recipient</th>
<th>Date & Time</th>
<th>From Wallet</th>
<th>Mpesa Code</th>
<th>Amount</th>
<th>Status</th>
<th>Action</th>
</tr>
</thead>
<tbody>
{% for transaction in transactions %}
<tr class="transaction-row" style="cursor: pointer;" onclick="showTransactionDetails('{{ transaction.id }}')">
<td>
<div class="d-flex align-items-center">
<i class="fa fa-arrow-right text-danger me-2"></i>
<div>
<p class="mb-0">{{ transaction.receiver.get_full_name|default:transaction.receiver_party_public_name|default:"-" }}</p>
<small class="text-muted">To: {{ transaction.receiver_wallet.wallet_name|default:"-" }}</small>
</div>
</div>
</td>
<td>{{ transaction.date|date:"d M Y" }}<br><small class="text-muted">{{ transaction.date|time:"g:i A" }}</small></td>
<td>
<p class="mb-0">{{ transaction.sender_wallet.wallet_name|default:"Primary Wallet" }}</p>
<small class="text-muted">{{ transaction.sender_wallet.wallet_id }}</small>
</td>
<td>
<span style="font-family: 'Courier New', monospace; font-weight: bold; color: var(--primary-color);">
{{ transaction.mpesa_code|default:transaction.transaction_id }}
</span>
</td>
<td>KES {{ transaction.amount|floatformat:2|intcomma }}</td>
<td>
<span class="badge {% if transaction.status == 'completed' %}bg-success{% elif transaction.status == 'pending' %}bg-warning{% else %}bg-danger{% endif %}">
{{ transaction.status|title }}
</span>
</td>
<td>
<button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); showTransactionDetails('{{ transaction.id }}')">
<i class="fa fa-eye"></i>
</button>
</td>
</tr>
{% empty %}
<tr><td colspan="7" class="text-center py-4">No recent transactions</td></tr>
{% endfor %}
</tbody>
</table>
</div>

<!-- Mobile Cards View -->
<div class="d-block d-lg-none">
{% for transaction in transactions %}
<div class="card mobile-transfer-card mb-3">
<div class="card-body">
<div class="d-flex justify-content-between align-items-start mb-2">
<div>
<h6 class="mb-1 fw-bold">KES {{ transaction.amount|floatformat:2|intcomma }}</h6>
<small class="text-muted">Mpesa: {{ transaction.mpesa_code|default:transaction.transaction_id }}</small>
</div>
<div>
{% if transaction.status == 'completed' %}
<span class="badge bg-success status-badge">{{ transaction.status|title }}</span>
{% elif transaction.status == 'failed' or transaction.status == 'cancelled' %}
<span class="badge bg-danger status-badge">{{ transaction.status|title }}</span>
{% else %}
<span class="badge bg-warning status-badge text-dark">{{ transaction.status|title }}</span>
{% endif %}
</div>
</div>
<div class="mb-2">
<strong>Recipient:</strong> {{ transaction.receiver.get_full_name|default:transaction.receiver_party_public_name|default:"-" }}<br>
<small class="text-muted">{{ transaction.date|date:"M d, Y H:i" }}</small>
</div>
<div class="d-flex justify-content-between align-items-center">
<div>
<small class="text-muted">From: {{ transaction.sender_wallet.wallet_name|default:"Primary Wallet" }}</small>
</div>
<div>
<button class="btn btn-primary btn-sm view-btn" data-bs-toggle="modal" data-bs-target="#transactionModal" onclick="showTransactionDetails('{{ transaction.id }}')">
<i class="fas fa-eye"></i>
</button>
</div>
</div>
</div>
</div>
{% empty %}
<div class="alert alert-info text-center my-4">No transfers found</div>
{% endfor %}
</div>

<!-- Pagination -->
<nav aria-label="Transfers pagination" class="mt-4">
<ul class="pagination justify-content-center mb-0" id="paginationControls"></ul>
</nav>
</div>
</div>

<!-- Transaction Details Modal -->
<div class="modal fade" id="transactionModal" tabindex="-1">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title"><i class="fa fa-receipt me-2"></i>Transfer Details</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<div class="row">
<div class="col-md-6">
<div class="mb-3 pb-3 border-bottom">
<strong class="text-muted">Transaction ID</strong>
<div class="fw-bold text-primary" id="modalTransactionId" style="font-family: 'Courier New', monospace;">-</div>
</div>
<div class="mb-3 pb-3 border-bottom">
<strong class="text-muted">Mpesa Code</strong>
<div class="fw-bold text-primary" id="modalMpesaCode" style="font-family: 'Courier New', monospace;">-</div>
</div>
<div class="mb-3 pb-3 border-bottom">
<strong class="text-muted">Recipient</strong>
<div id="modalRecipient">-</div>
</div>
<div class="mb-3 pb-3 border-bottom">
<strong class="text-muted">Recipient Wallet</strong>
<div id="modalRecipientWallet">-</div>
</div>
<div class="mb-3 pb-3 border-bottom">
<strong class="text-muted">From Wallet</strong>
<div id="modalFromWallet">-</div>
<small class="text-muted d-block" id="modalFromWalletId">-</small>
</div>
<div class="mb-3 pb-3 border-bottom">
<strong class="text-muted">Date & Time</strong>
<div id="modalDateTime">-</div>
</div>
</div>
<div class="col-md-6">
<div class="mb-3 pb-3 border-bottom">
<strong class="text-muted">Amount</strong>
<div class="fs-4 fw-bold text-success" id="modalAmount">-</div>
</div>
<div class="mb-3 pb-3 border-bottom">
<strong class="text-muted">Status</strong>
<div id="modalStatus">-</div>
</div>
<div class="mb-3 pb-3 border-bottom">
<strong class="text-muted">Transaction Type</strong>
<div id="modalType">-</div>
</div>
<div class="mb-3">
<strong class="text-muted">Description</strong>
<div id="modalDescription">-</div>
</div>
</div>
</div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
</div>
</div>
</div>
</div>

</div>
</div>
</div>
</div>
</section>

<!-- Include the partial modals -->
{% include 'partials/transfer.html' %}
{% include 'partials/new_wallet.html' %}
{% include 'partials/fund.html' %}

<script>
let allTransactions = [
    {% for transaction in transactions %}
    {
        id: '{{ transaction.id }}',
        transaction_id: '{{ transaction.transaction_id }}',
        mpesa_code: '{{ transaction.mpesa_code|default:"-"|escapejs }}',
        recipient_name: '{{ transaction.receiver.get_full_name|default:transaction.receiver_party_public_name|default:"-"|escapejs }}',
        recipient_wallet: '{{ transaction.receiver_wallet.wallet_name|default:"-"|escapejs }}',
        from_wallet_name: '{{ transaction.sender_wallet.wallet_name|default:"Primary Wallet"|escapejs }}',
        from_wallet_id: '{{ transaction.sender_wallet.wallet_id|default:"-" }}',
        date: '{{ transaction.date|date:"d M Y" }}',
        time: '{{ transaction.date|time:"g:i A" }}',
        amount: {{ transaction.amount }},
        status: '{{ transaction.status }}',
        type: '{{ transaction.transaction_type|default:"Wallet Transfer"|escapejs }}',
        description: '{{ transaction.description|default:"No description"|escapejs }}'
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

function showTransactionDetails(id) {
    const txn = allTransactions.find(t => t.id === id);
    if (!txn) return;
    document.getElementById('modalTransactionId').textContent = txn.transaction_id;
    document.getElementById('modalMpesaCode').textContent = txn.mpesa_code;
    document.getElementById('modalRecipient').textContent = txn.recipient_name;
    document.getElementById('modalRecipientWallet').textContent = txn.recipient_wallet;
    document.getElementById('modalFromWallet').textContent = txn.from_wallet_name;
    document.getElementById('modalFromWalletId').textContent = 'ID: ' + txn.from_wallet_id;
    document.getElementById('modalDateTime').textContent = txn.date + ', ' + txn.time;
    document.getElementById('modalAmount').textContent = 'KES ' + parseFloat(txn.amount).toLocaleString('en-US', {minimumFractionDigits: 2});
    const statusClass = txn.status === 'completed' ? 'bg-success' : txn.status === 'pending' ? 'bg-warning' : 'bg-danger';
    document.getElementById('modalStatus').innerHTML = `<span class="badge ${statusClass}">${txn.status.charAt(0).toUpperCase() + txn.status.slice(1)}</span>`;
    document.getElementById('modalType').textContent = txn.type;
    document.getElementById('modalDescription').textContent = txn.description;
    bootstrap.Modal.getOrCreateInstance(document.getElementById('transactionModal')).show();
}
</script>
{% endblock %}