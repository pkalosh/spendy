{% extends "partials/dashboard-base.html" %}
{% load static %}

{% block content %}
<!-- Dashboard Section start -->
<section class="dashboard-section body-collapse">
    <div class="overlay pt-120">
        <div class="container-fluid">
            <div class="main-content">
                <div class="row">

                    <!-- Company Info Header -->
                    <div class="col-12 mb-4">
                        <div class="d-flex justify-content-between align-items-center bg-white rounded-3 p-3 shadow-sm">
                            <div class="d-flex align-items-center">
                                <div class="company-logo me-3">
                                    <img src="{{ kyc.logo.url }}" alt="Company Logo" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover;">
                                </div>
                                <div>
                                    <h5 class="mb-0">{{ kyc.company_name|title }}</h5>
                                    <p class="mb-0 text-cyan">{{ primary_wallet.wallet_number }}</p>
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editAccountModal">Edit Company Info</button>
                            </div>
                        </div>
                    </div>

                    <!-- Account Balance Card -->
                    <div class="col-lg-8 mb-4">
                        <div class="bg-white rounded-3 p-4 shadow-sm">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <div>
                                    <p class="text-muted mb-1">Primary Wallet Balance</p>
                                    <h6 class="mb-0">KES {{ primary_wallet.balance|floatformat:2 }}</h6>
                                </div>
                                <div>
                                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createWalletModal">Create Wallet</button>
                                </div>
                            </div>

                            <div class="progress mb-4" style="height: 10px;">
                                <div class="progress-bar bg-success" role="progressbar" style="width: {{ income_percentage }}%;" aria-valuenow="{{ income_percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>

                            <div class="row">
                                {% for wallet in wallets %}
                                <div class="col-md-3 mb-3 position-relative">
                                    <div class="card border-0" style="box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                                        <div class="card-body">
                                            <!-- Options button (three dots) -->
                                            <div class="dropdown float-end">
                                                <button class="btn btn-light btn-sm" type="button" id="walletOptions{{ wallet.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                                                    <i class="fas fa-ellipsis-v"></i>
                                                </button>
                                                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="walletOptions{{ wallet.id }}">
                                                    <li><a class="dropdown-item" href="">View</a></li>
                                                    <li><a class="dropdown-item" href="">Edit</a></li>
                                                    <li><a class="dropdown-item" href="">Fund</a></li>
                                                    <li><a class="dropdown-item text-danger" href="">Close</a></li>
                                                </ul>
                                            </div>
                                
                                            <!-- Wallet Info -->
                                            <div class="text-center mt-4">
                                                <h6 class="text-muted">{{ wallet.name }}</h6>
                                                <h5 class="mb-0">KES {{ wallet.balance|floatformat:2 }}</h5>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                {% empty %}
                                <div class="col-12 text-center">
                                    <p>No wallets available.</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                <!-- Actions Card -->
                <div class="col-lg-4 mb-4">
                    <div class="bg-white rounded-3 p-4 shadow-sm h-100 position-relative">
                        <h5 class="mb-4">Wallet Actions</h5>

                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#sendMoneyModal">Send Money</button>
                            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#fundWalletModal">Fund Wallet</button>
                        </div>
                    </div>
                </div>


                    <!-- Recent Payments -->
                    <div class="col-12 mb-4">
                        <div class="bg-white rounded-3 p-4 shadow-sm">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5 class="mb-0">Payments</h5>
                                <a href="" class="btn btn-sm btn-primary">View More</a>
                            </div>
                            <div class="table-responsive">
                                <table class="table align-middle">
                                    <thead>
                                        <tr>
                                            <th>Recipient</th>
                                            <th>Date</th>
                                            <th>Account Number</th>
                                            <th>Reference</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for transaction in transactions %}
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <i class="fa fa-arrow-right text-danger me-2"></i>
                                                    <div>
                                                        <p class="mb-0">{{ transaction.company }}</p>
                                                        <small class="text-muted">{{ transaction.transaction_type }}</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                {{ transaction.date|date:"d M Y" }}<br>
                                                <small class="text-muted">{{ transaction.time }}</small>
                                            </td>
                                            <td>{{ transaction.account_number }}</td>
                                            <td>{{ transaction.transaction_id }}</td>
                                            <td>KES {{ transaction.amount|floatformat:2 }}</td>
                                            <td>
                                                <span class="badge {% if transaction.status == 'completed' %}bg-success{% else %}bg-warning{% endif %}">
                                                    {{ transaction.status }}
                                                </span>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="6" class="text-center">No recent transactions</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Company KYC Details -->
                    <div class="accordion" id="companyKycAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="companyKycHeading">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#companyKycCollapse" aria-expanded="true" aria-controls="companyKycCollapse">
                                    Company KYC Details
                                </button>
                            </h2>
                            <div id="companyKycCollapse" class="accordion-collapse collapse" aria-labelledby="companyKycHeading" data-bs-parent="#companyKycAccordion">
                                <div class="accordion-body">
                                    {% if kyc %}
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Company Name</label>
                                            <input type="text" class="form-control" readonly value="{{ kyc.company_name|title }}">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Email</label>
                                            <input type="text" class="form-control" readonly value="{{ kyc.user.email }}">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Date of Registration</label>
                                            <input type="text" class="form-control" readonly value="{{ kyc.date|date:'d M, Y' }}">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Mobile</label>
                                            <input type="text" class="form-control" readonly value="{{ kyc.mobile }}">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Country</label>
                                            <input type="text" class="form-control" readonly value="{{ kyc.country|title }}">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">County</label>
                                            <input type="text" class="form-control" readonly value="{{ kyc.county|title }}">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">City</label>
                                            <input type="text" class="form-control" readonly value="{{ kyc.city|title }}">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Address</label>
                                            <input type="text" class="form-control" readonly value="{{ kyc.address|title }}">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">KRA File</label><br>
                                            <a href="{{ kyc.kra_pin.url }}" target="_blank" class="btn btn-outline-primary btn-sm">View KRA Document</a>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Incorporation Certificate</label><br>
                                            <a href="{{ kyc.registration_certificate.url }}" target="_blank" class="btn btn-outline-primary btn-sm">View Certificate</a>
                                        </div>
                                    </div>
                                    {% else %}
                                    <p class="text-muted">Company KYC details not available.</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    

                </div> <!-- Row End -->
            </div> <!-- Main Content End -->
        </div> <!-- Container End -->
    </div> <!-- Overlay End -->
</section>
<!-- Dashboard Section end -->

<!-- Create Wallet Modal -->
<div class="modal fade" id="createWalletModal" tabindex="-1" aria-labelledby="createWalletModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="margin-top: 80px;">
        <div class="modal-content">
            <form method="post" action="">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="createWalletModalLabel">Create Wallet</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="walletName" class="form-label">Wallet Name</label>
                        <input type="text" class="form-control" id="walletName" name="wallet_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="walletAmount" class="form-label">Initial Amount</label>
                        <input type="number" class="form-control" id="walletAmount" name="initial_amount" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Create</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Account Modal -->
<div class="modal fade" id="editAccountModal" tabindex="-1" aria-labelledby="editAccountModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="margin-top: 80px;">
        <div class="modal-content">
            <!-- You can put Edit Account form here -->
        </div>
    </div>
</div>

<!-- Send Money Modal -->
<!-- Send Money Modal -->
<div class="modal fade" id="sendMoneyModal" tabindex="-1" aria-labelledby="sendMoneyModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="margin-top: 80px;">
      <div class="modal-content">
  
        <div class="modal-header">
          <h5 class="modal-title" id="sendMoneyModalLabel">Send Money</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
  
        <div class="modal-body">
          <form id="sendMoneyForm">
            <!-- From Wallet -->
            <div class="mb-3">
              <label for="fromWallet" class="form-label">From Wallet</label>
              <input type="text" class="form-control" id="fromWallet" placeholder="Enter source wallet ID or number">
            </div>
  
            <!-- Select Send Type -->
            <div class="mb-3">
              <label for="sendType" class="form-label">Send To</label>
              <select class="form-select" id="sendType" onchange="handleSendTypeChange()">
                <option value="" disabled selected>Select destination type</option>
                <option value="mobile">Mobile Number</option>
                <option value="till">Till Number</option>
                <option value="paybill">Paybill Number</option>
                <option value="bank">Bank Account</option>
                <option value="wallet">Another Wallet</option>
              </select>
            </div>
  
            <!-- Dynamic To Fields -->
            <div id="sendFields"></div>
  
            <!-- Amount -->
            <div class="mb-3">
              <label for="sendAmount" class="form-label">Amount</label>
              <input type="number" class="form-control" id="sendAmount" placeholder="Enter amount to send">
            </div>
          </form>
        </div>
  
        <div class="modal-footer">
          <button type="button" class="btn btn-primary">Proceed</button>
        </div>
  
      </div>
    </div>
  </div>
  
<!-- Fund Wallet Modal -->
<!-- Fund Wallet Modal -->
<div class="modal fade" id="fundWalletModal" tabindex="-1" aria-labelledby="fundWalletModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="margin-top: 80px;">
      <div class="modal-content">
  
        <div class="modal-header">
          <h5 class="modal-title" id="fundWalletModalLabel">Fund Wallet</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
  
        <div class="modal-body">
          <form id="fundWalletForm">
            <!-- To Wallet -->
            <div class="mb-3">
              <label for="toWallet" class="form-label">To Wallet</label>
              <input type="text" class="form-control" id="toWallet" placeholder="Enter your wallet ID to fund">
            </div>
  
            <!-- Fund Source Type -->
            <div class="mb-3">
              <label for="fundType" class="form-label">Fund From</label>
              <select class="form-select" id="fundType" onchange="handleFundTypeChange()">
                <option value="" disabled selected>Select funding method</option>
                <option value="mobile">Mobile Money</option>
                <option value="bank">Bank Transfer</option>
                <option value="card">Credit/Debit Card</option>
              </select>
            </div>
  
            <!-- Dynamic Fund Source Fields -->
            <div id="fundFields"></div>
  
            <!-- Amount -->
            <div class="mb-3">
              <label for="fundAmount" class="form-label">Amount</label>
              <input type="number" class="form-control" id="fundAmount" placeholder="Enter amount to fund">
            </div>
          </form>
        </div>
  
        <div class="modal-footer">
          <button type="button" class="btn btn-success">Fund</button>
        </div>
  
      </div>
    </div>
  </div>
  
  <script>
    function handleSendTypeChange() {
        const sendType = document.getElementById('sendType').value;
        const sendFields = document.getElementById('sendFields');
        let html = '';
    
        if (sendType === 'mobile') {
            html = `
              <div class="mb-3">
                <label for="mobileNumber" class="form-label">Mobile Number</label>
                <input type="text" class="form-control" id="mobileNumber" placeholder="Enter mobile number">
              </div>`;
        } else if (sendType === 'till') {
            html = `
              <div class="mb-3">
                <label for="tillNumber" class="form-label">Till Number</label>
                <input type="text" class="form-control" id="tillNumber" placeholder="Enter till number">
              </div>`;
        } else if (sendType === 'paybill') {
            html = `
              <div class="mb-3">
                <label for="paybillNumber" class="form-label">Paybill Number</label>
                <input type="text" class="form-control" id="paybillNumber" placeholder="Enter paybill number">
              </div>
              <div class="mb-3">
                <label for="accountNumber" class="form-label">Account Number</label>
                <input type="text" class="form-control" id="accountNumber" placeholder="Enter account number">
              </div>`;
        } else if (sendType === 'bank') {
            html = `
              <div class="mb-3">
                <label for="bankName" class="form-label">Bank Name</label>
                <input type="text" class="form-control" id="bankName" placeholder="Enter bank name">
              </div>
              <div class="mb-3">
                <label for="bankAccount" class="form-label">Bank Account Number</label>
                <input type="text" class="form-control" id="bankAccount" placeholder="Enter bank account number">
              </div>`;
        } else if (sendType === 'wallet') {
            html = `
              <div class="mb-3">
                <label for="walletId" class="form-label">Wallet ID</label>
                <input type="text" class="form-control" id="walletId" placeholder="Enter wallet ID">
              </div>`;
        }
    
        sendFields.innerHTML = html;
    }
    
    function handleFundTypeChange() {
        const fundType = document.getElementById('fundType').value;
        const fundFields = document.getElementById('fundFields');
        let html = '';
    
        if (fundType === 'mobile') {
            html = `
              <div class="mb-3">
                <label for="fundMobileNumber" class="form-label">Mobile Number</label>
                <input type="text" class="form-control" id="fundMobileNumber" placeholder="Enter mobile number">
              </div>`;
        } else if (fundType === 'bank') {
            html = `
              <div class="mb-3">
                <label for="fundBankName" class="form-label">Bank Name</label>
                <input type="text" class="form-control" id="fundBankName" placeholder="Enter bank name">
              </div>
              <div class="mb-3">
                <label for="fundBankAccount" class="form-label">Bank Account Number</label>
                <input type="text" class="form-control" id="fundBankAccount" placeholder="Enter bank account number">
              </div>`;
        } else if (fundType === 'card') {
            html = `
              <div class="mb-3">
                <label for="cardNumber" class="form-label">Card Number</label>
                <input type="text" class="form-control" id="cardNumber" placeholder="Enter card number">
              </div>
              <div class="mb-3">
                <label for="cardExpiry" class="form-label">Expiry Date</label>
                <input type="text" class="form-control" id="cardExpiry" placeholder="MM/YY">
              </div>
              <div class="mb-3">
                <label for="cardCVC" class="form-label">CVC</label>
                <input type="text" class="form-control" id="cardCVC" placeholder="CVC">
              </div>`;
        }
    
        fundFields.innerHTML = html;
    }
    </script>
      

{% endblock content %}
