{% extends "partials/user-base.html" %}
{% load static %}
{% load humanize %}
{% block content %}
<section class="dashboard-section body-collapse">
    <div class="overlay pt-120">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <!-- Request Management Section -->
                    <div class="requests-area">
                        <div class="d-flex justify-content-between align-items-center mb-4 pt-3 flex-wrap mt-3">
                            <h4 class="text-2xl font-bold">Expense Requests</h4>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#submitExpenseModal">
                                New Request
                            </button>
                        </div>

                        <!-- Type Selection Tabs -->
                        <ul class="nav nav-tabs mb-4" id="expenseTypeTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all-expenses" type="button" role="tab" aria-controls="all-expenses" aria-selected="true">All Requests</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="events-tab" data-bs-toggle="tab" data-bs-target="#events-expenses" type="button" role="tab" aria-controls="events-expenses" aria-selected="false">Events</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="operations-tab" data-bs-toggle="tab" data-bs-target="#operations-expenses" type="button" role="tab" aria-controls="operations-expenses" aria-selected="false">Operations</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="activations-tab" data-bs-toggle="tab" data-bs-target="#activations-expenses" type="button" role="tab" aria-controls="activations-expenses" aria-selected="false">Activations</button>
                            </li>
                        </ul>

                        <!-- Filter Controls -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="btn-group" role="group" aria-label="Request filter">
                                            <button type="button" class="btn btn-outline-primary active" data-filter="all">All Requests</button>
                                            <button type="button" class="btn btn-outline-warning" data-filter="pending">Pending</button>
                                            <button type="button" class="btn btn-outline-success" data-filter="approved">Approved</button>
                                            <button type="button" class="btn btn-outline-danger" data-filter="declined">Declined</button>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <input type="text" class="form-control" id="requestSearch" placeholder="Search requests...">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tab Content -->
                        <div class="tab-content" id="expenseTabContent">
                            <!-- All Expenses Tab -->
                            <div class="tab-pane fade show active" id="all-expenses" role="tabpanel" aria-labelledby="all-tab">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover" id="allRequestsTable">
                                        <thead class="bg-light">
                                            <tr>
                                                <th>Status</th>
                                                <th>Expense Type</th>
                                                <th>Expense Category</th>
                                                <th>Batch</th>
                                                <th>Description</th>
                                                <th>Amount</th>
                                                <th>Date</th>
                                                <th>Requested By</th>
                                                <th>Reviewed By</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for expense in pending_expenses %}
                                            <tr class="request-row pending-request">
                                                <td><span class="badge bg-warning">Pending</span></td>
                                                <td>{{ expense.request_type }}</td>
                                                <td>{{ expense.expense_category }}</td>
                                                <td>{{ expense.batch_disbursement_type|yesno:"Yes,No" }}</td>
                                                <td>{{ expense.description }}</td>
                                                <td>{{ expense.amount|intcomma }}</td>
                                                <td>{{ expense.created_at|date:"M d, Y" }}</td>
                                                <td>{{ expense.created_by.get_full_name }}</td>
                                                <td>-</td>
                                            </tr>
                                            {% endfor %}
                                            {% for expense in approved_expenses %}
                                            <tr class="request-row approved-request">
                                                <td><span class="badge bg-success">Approved</span></td>
                                                <td>{{ expense.request_type }}</td>
                                                <td>{{ expense.expense_category }}</td>
                                                <td>{{ expense.batch_disbursement_type|yesno:"Yes,No" }}</td>
                                                <td>{{ expense.description }}</td>
                                                <td>{{ expense.amount|intcomma }}</td>
                                                <td>{{ expense.updated_at|date:"M d, Y" }}</td>
                                                <td>{{ expense.created_by.get_full_name }}</td>
                                                <td>{{ expense.approved_by.get_full_name|default:"-" }}</td>
                                            </tr>
                                            {% endfor %}
                                            {% for expense in declined_expenses %}
                                            <tr class="request-row declined-request">
                                                <td><span class="badge bg-danger">Declined</span></td>
                                                <td>{{ expense.request_type }}</td>
                                                <td>{{ expense.expense_category }}</td>
                                                <td>{{ expense.batch_disbursement_type|yesno:"Yes,No" }}</td>
                                                <td>{{ expense.description }}</td>
                                                <td>{{ expense.amount|intcomma }}</td>
                                                <td>{{ expense.updated_at|date:"M d, Y" }}</td>
                                                <td>{{ expense.created_by.get_full_name }}</td>
                                                <td>{{ expense.approved_by.get_full_name|default:"-" }}</td>
                                            </tr>
                                            {% endfor %}
                                            {% if not pending_expenses and not approved_expenses and not declined_expenses %}
                                            <tr>
                                                <td colspan="9" class="text-center">No requests found.</td>
                                            </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Events Tab -->
                            <div class="tab-pane fade" id="events-expenses" role="tabpanel" aria-labelledby="events-tab">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover" id="eventsRequestsTable">
                                        <thead class="bg-light">
                                            <tr>
                                                <th>Status</th>
                                                <th>Event Name</th>
                                                <th>Expense Category</th>
                                                <th>Batch</th>
                                                <th>Description</th>
                                                <th>Amount</th>
                                                <th>Date</th>
                                                <th>Requested By</th>
                                                <th>Reviewed By</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for expense in pending_expenses %}
                                            {% if expense.event %}
                                            <tr class="request-row pending-request">
                                                <td><span class="badge bg-warning">Pending</span></td>
                                                <td>{{ expense.event.name }}</td>
                                                <td>{{ expense.expense_category }}</td>
                                                <td>{{ expense.batch_disbursement_type|yesno:"Yes,No" }}</td>
                                                <td>{{ expense.description }}</td>
                                                <td>{{ expense.amount|intcomma }}</td>
                                                <td>{{ expense.created_at|date:"M d, Y" }}</td>
                                                <td>{{ expense.created_by.get_full_name }}</td>
                                                <td>-</td>
                                            </tr>
                                            {% endif %}
                                            {% endfor %}
                                            {% for expense in approved_expenses %}
                                            {% if expense.event %}
                                            <tr class="request-row approved-request">
                                                <td><span class="badge bg-success">Approved</span></td>
                                                <td>{{ expense.event.name }}</td>
                                                <td>{{ expense.expense_category }}</td>
                                                <td>{{ expense.batch_disbursement_type|yesno:"Yes,No" }}</td>
                                                <td>{{ expense.description }}</td>
                                                <td>{{ expense.amount|intcomma }}</td>
                                                <td>{{ expense.updated_at|date:"M d, Y" }}</td>
                                                <td>{{ expense.created_by.get_full_name }}</td>
                                                <td>{{ expense.approved_by.get_full_name|default:"-" }}</td>
                                            </tr>
                                            {% endif %}
                                            {% endfor %}
                                            {% for expense in declined_expenses %}
                                            {% if expense.event %}
                                            <tr class="request-row declined-request">
                                                <td><span class="badge bg-danger">Declined</span></td>
                                                <td>{{ expense.event.name }}</td>
                                                <td>{{ expense.expense_category }}</td>
                                                <td>{{ expense.batch_disbursement_type|yesno:"Yes,No" }}</td>
                                                <td>{{ expense.description }}</td>
                                                <td>{{ expense.amount|intcomma }}</td>
                                                <td>{{ expense.updated_at|date:"M d, Y" }}</td>
                                                <td>{{ expense.created_by.get_full_name }}</td>
                                                <td>{{ expense.approved_by.get_full_name|default:"-" }}</td>
                                            </tr>
                                            {% endif %}
                                            {% endfor %}
                                            {% if not has_event_expenses %}
                                            <tr>
                                                <td colspan="9" class="text-center">No event requests found.</td>
                                            </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Operations Tab -->
                            <div class="tab-pane fade" id="operations-expenses" role="tabpanel" aria-labelledby="operations-tab">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover" id="operationsRequestsTable">
                                        <thead class="bg-light">
                                            <tr>
                                                <th>Status</th>
                                                <th>Operation</th>
                                                <th>Expense Category</th>
                                                <th>Batch</th>
                                                <th>Description</th>
                                                <th>Amount</th>
                                                <th>Date</th>
                                                <th>Requested By</th>
                                                <th>Reviewed By</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for expense in pending_expenses %}
                                            {% if expense.operation %}
                                            <tr class="request-row pending-request">
                                                <td><span class="badge bg-warning">Pending</span></td>
                                                <td>{{ expense.operation.name }}</td>
                                                <td>{{ expense.expense_category }}</td>
                                                <td>{{ expense.batch_disbursement_type|yesno:"Yes,No" }}</td>
                                                <td>{{ expense.description }}</td>
                                                <td>{{ expense.amount|intcomma }}</td>
                                                <td>{{ expense.created_at|date:"M d, Y" }}</td>
                                                <td>{{ expense.created_by.get_full_name }}</td>
                                                <td>-</td>
                                            </tr>
                                            {% endif %}
                                            {% endfor %}
                                            {% for expense in approved_expenses %}
                                            {% if expense.operation %}
                                            <tr class="request-row approved-request">
                                                <td><span class="badge bg-success">Approved</span></td>
                                                <td>{{ expense.operation.name }}</td>
                                                <td>{{ expense.expense_category }}</td>
                                                <td>{{ expense.batch_disbursement_type|yesno:"Yes,No" }}</td>
                                                <td>{{ expense.description }}</td>
                                                <td>{{ expense.amount|intcomma }}</td>
                                                <td>{{ expense.updated_at|date:"M d, Y" }}</td>
                                                <td>{{ expense.created_by.get_full_name }}</td>
                                                <td>{{ expense.approved_by.get_full_name|default:"-" }}</td>
                                            </tr>
                                            {% endif %}
                                            {% endfor %}
                                            {% for expense in declined_expenses %}
                                            {% if expense.operation %}
                                            <tr class="request-row declined-request">
                                                <td><span class="badge bg-danger">Declined</span></td>
                                                <td>{{ expense.operation.name }}</td>
                                                <td>{{ expense.expense_category }}</td>
                                                <td>{{ expense.batch_disbursement_type|yesno:"Yes,No" }}</td>
                                                <td>{{ expense.description }}</td>
                                                <td>{{ expense.amount|intcomma }}</td>
                                                <td>{{ expense.updated_at|date:"M d, Y" }}</td>
                                                <td>{{ expense.created_by.get_full_name }}</td>
                                                <td>{{ expense.approved_by.get_full_name|default:"-" }}</td>
                                            </tr>
                                            {% endif %}
                                            {% endfor %}
                                            {% if not has_operation_expenses %}
                                            <tr>
                                                <td colspan="9" class="text-center">No operation requests found.</td>
                                            </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Activations Tab -->
                            <div class="tab-pane fade" id="activations-expenses" role="tabpanel" aria-labelledby="activations-tab">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover" id="activationsRequestsTable">
                                        <thead class="bg-light">
                                            <tr>
                                                <th>Status</th>
                                                <th>Activation</th>
                                                <th>Expense Category</th>
                                                <th>Batch</th>
                                                <th>Description</th>
                                                <th>Amount</th>
                                                <th>Date</th>
                                                <th>Requested By</th>
                                                <th>Reviewed By</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for expense in pending_expenses %}
                                            {% if expense.activation %}
                                            <tr class="request-row pending-request">
                                                <td><span class="badge bg-warning">Pending</span></td>
                                                <td>{{ expense.activation.name }}</td>
                                                <td>{{ expense.expense_category }}</td>
                                                <td>{{ expense.batch_disbursement_type|yesno:"Yes,No" }}</td>
                                                <td>{{ expense.description }}</td>
                                                <td>{{ expense.amount|intcomma }}</td>
                                                <td>{{ expense.created_at|date:"M d, Y" }}</td>
                                                <td>{{ expense.created_by.get_full_name }}</td>
                                                <td>-</td>
                                            </tr>
                                            {% endif %}
                                            {% endfor %}
                                            {% for expense in approved_expenses %}
                                            {% if expense.activation %}
                                            <tr class="request-row approved-request">
                                                <td><span class="badge bg-success">Approved</span></td>
                                                <td>{{ expense.activation.name }}</td>
                                                <td>{{ expense.expense_category }}</td>
                                                <td>{{ expense.batch_disbursement_type|yesno:"Yes,No" }}</td>
                                                <td>{{ expense.description }}</td>
                                                <td>{{ expense.amount|intcomma }}</td>
                                                <td>{{ expense.updated_at|date:"M d, Y" }}</td>
                                                <td>{{ expense.created_by.get_full_name }}</td>
                                                <td>{{ expense.approved_by.get_full_name|default:"-" }}</td>
                                            </tr>
                                            {% endif %}
                                            {% endfor %}
                                            {% for expense in declined_expenses %}
                                            {% if expense.activation %}
                                            <tr class="request-row declined-request">
                                                <td><span class="badge bg-danger">Declined</span></td>
                                                <td>{{ expense.activation.name }}</td>
                                                <td>{{ expense.expense_category }}</td>
                                                <td>{{ expense.batch_disbursement_type|yesno:"Yes,No" }}</td>
                                                <td>{{ expense.description }}</td>
                                                <td>{{ expense.amount|intcomma }}</td>
                                                <td>{{ expense.updated_at|date:"M d, Y" }}</td>
                                                <td>{{ expense.created_by.get_full_name }}</td>
                                                <td>{{ expense.approved_by.get_full_name|default:"-" }}</td>
                                            </tr>
                                            {% endif %}
                                            {% endfor %}
                                            {% if not has_activation_expenses %}
                                            <tr>
                                                <td colspan="9" class="text-center">No activation requests found.</td>
                                            </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Mobile view cards with tabs -->
                        <div class="d-md-none">
                            <div class="tab-content" id="expenseMobileTabContent">
                                <!-- All Expenses Mobile Tab -->
                                <div class="tab-pane fade show active" id="all-expenses-mobile" role="tabpanel" aria-labelledby="all-tab">
                                    <div class="request-cards">
                                        {% for expense in pending_expenses %}
                                        <div class="card mb-3 request-card pending-request">
                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                <span class="badge bg-warning">Pending</span>
                                                <small>{{ expense.created_at|date:"M d, Y" }}</small>
                                            </div>
                                            <div class="card-body">
                                                <h6 class="card-subtitle mb-2">{{ expense.request_type }}</h6>
                                                <p class="card-text">
                                                    <strong>For:</strong> {% if expense.event %}{{ expense.event.name }}{% elif expense.operation %}{{ expense.operation.name }}{% elif expense.activation %}{{ expense.activation.name }}{% else %}General{% endif %}<br>
                                                    <strong>Batch:</strong> {{ expense.batch_disbursement_type|yesno:"Yes,No" }}<br>
                                                    <strong>Amount:</strong> {{ expense.amount|intcomma }}<br>
                                                    <strong>Description:</strong> {{ expense.description|truncatechars:80 }}<br>
                                                    <strong>By:</strong> {{ expense.created_by.get_full_name }}
                                                </p>
                                                <div class="d-flex gap-2">
                                                    <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#viewRequestModal{{ expense.id }}">View</button>
                                                    {% if is_admin %}
                                                    <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#approveModal{{ expense.id }}">Approve</button>
                                                    <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#declineModal{{ expense.id }}">Decline</button>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                        <!-- Approved and Declined expenses follow similar pattern -->
                                    </div>
                                </div>

                                <!-- Events Mobile Tab -->
                                <div class="tab-pane fade" id="events-expenses-mobile" role="tabpanel" aria-labelledby="events-tab">
                                    <div class="request-cards">
                                        {% for expense in pending_expenses %}
                                        {% if expense.event %}
                                        <div class="card mb-3 request-card pending-request">
                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                <span class="badge bg-warning">Pending</span>
                                                <small>{{ expense.created_at|date:"M d, Y" }}</small>
                                            </div>
                                            <div class="card-body">
                                                <h6 class="card-subtitle mb-2">Event: {{ expense.event.name }}</h6>
                                                <p class="card-text">
                                                    <strong>Batch:</strong> {{ expense.batch_disbursement_type|yesno:"Yes,No" }}<br>
                                                    <strong>Amount:</strong> {{ expense.amount|intcomma }}<br>
                                                    <strong>Description:</strong> {{ expense.description|truncatechars:80 }}<br>
                                                    <strong>By:</strong> {{ expense.created_by.get_full_name }}
                                                </p>
                                                <div class="d-flex gap-2">
                                                    <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#viewRequestModal{{ expense.id }}">View</button>
                                                    {% if is_admin %}
                                                    <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#approveModal{{ expense.id }}">Approve</button>
                                                    <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#declineModal{{ expense.id }}">Decline</button>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        {% endfor %}
                                        <!-- Approved and Declined event expenses follow similar pattern -->
                                    </div>
                                </div>

                                <!-- Operations Mobile Tab -->
                                <div class="tab-pane fade" id="operations-expenses-mobile" role="tabpanel" aria-labelledby="operations-tab">
                                    <div class="request-cards">
                                        {% for expense in pending_expenses %}
                                        {% if expense.operation %}
                                        <div class="card mb-3 request-card pending-request">
                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                <span class="badge bg-warning">Pending</span>
                                                <small>{{ expense.created_at|date:"M d, Y" }}</small>
                                            </div>
                                            <div class="card-body">
                                                <h6 class="card-subtitle mb-2">Operation: {{ expense.operation.name }}</h6>
                                                <p class="card-text">
                                                    <strong>Batch:</strong> {{ expense.batch_disbursement_type|yesno:"Yes,No" }}<br>
                                                    <strong>Amount:</strong> {{ expense.amount|intcomma }}<br>
                                                    <strong>Description:</strong> {{ expense.description|truncatechars:80 }}<br>
                                                    <strong>By:</strong> {{ expense.created_by.get_full_name }}
                                                </p>
                                                <div class="d-flex gap-2">
                                                    <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#viewRequestModal{{ expense.id }}">View</button>
                                                    {% if is_admin %}
                                                    <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#approveModal{{ expense.id }}">Approve</button>
                                                    <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#declineModal{{ expense.id }}">Decline</button>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        {% endfor %}
                                        <!-- Approved and Declined operation expenses follow similar pattern -->
                                    </div>
                                </div>

                                <!-- Activations Mobile Tab -->
                                <div class="tab-pane fade" id="activations-expenses-mobile" role="tabpanel" aria-labelledby="activations-tab">
                                    <div class="request-cards">
                                        {% for expense in pending_expenses %}
                                        {% if expense.activation %}
                                        <div class="card mb-3 request-card pending-request">
                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                <span class="badge bg-warning">Pending</span>
                                                <small>{{ expense.created_at|date:"M d, Y" }}</small>
                                            </div>
                                            <div class="card-body">
                                                <h6 class="card-subtitle mb-2">Activation: {{ expense.activation.name }}</h6>
                                                <p class="card-text">
                                                    <strong>Batch:</strong> {{ expense.batch_disbursement_type|yesno:"Yes,No" }}<br>
                                                    <strong>Amount:</strong> {{ expense.amount|intcomma }}<br>
                                                    <strong>Description:</strong> {{ expense.description|truncatechars:80 }}<br>
                                                    <strong>By:</strong> {{ expense.created_by.get_full_name }}
                                                </p>
                                                <div class="d-flex gap-2">
                                                    <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#viewRequestModal{{ expense.id }}">View</button>
                                                    {% if is_admin %}
                                                    <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#approveModal{{ expense.id }}">Approve</button>
                                                    <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#declineModal{{ expense.id }}">Decline</button>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        {% endfor %}
                                        <!-- Approved and Declined activation expenses follow similar pattern -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Submit Expense Modal -->
<div class="modal fade" id="submitExpenseModal" tabindex="-1" aria-labelledby="submitExpenseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title" id="submitExpenseModalLabel">New Expense Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="expense-form" method="post" action="{% url 'expense:submit_expense' %}" enctype="multipart/form-data" class="bg-white p-4 shadow rounded">
                    {% csrf_token %}
                    <input type="hidden" id="form_type" name="form_type">

                    <!-- Request Type Dropdown -->
                    <div class="mb-3">
                        <label for="id_request_type" class="form-label fw-bold required">Request Type</label>
                        {{ expense_form.request_type }}
                        <div class="invalid-feedback">Please select a request type.</div>
                    </div>

                    <!-- Event Field -->
                    <div class="mb-3 expense-section hidden" id="event-field">
                        <label for="id_event" class="form-label fw-bold required">Event</label>
                        {{ expense_form.event }}
                        <div class="invalid-feedback">Please select an event.</div>
                    </div>

                    <!-- Operation Field -->
                    <div class="mb-3 expense-section hidden" id="operation-field">
                        <label for="id_operation" class="form-label fw-bold required">Operation</label>
                        {{ expense_form.operation }}
                        <div class="invalid-feedback">Please select an operation.</div>
                    </div>

                    <!-- Activation Field -->
                    <div class="mb-3 expense-section hidden" id="activation-field">
                        <label for="id_activation" class="form-label fw-bold required">Activation</label>
                        {{ expense_form.activation }}
                        <div class="invalid-feedback">Please select an activation.</div>
                    </div>

                    <!-- Batch Disbursement Type Checkbox -->
                    <div class="mb-3">
                        <label for="id_batch_disbursement_type" class="form-label fw-bold">Batch Disbursement</label>
                        <div class="form-check">
                            {{ expense_form.batch_disbursement_type }}
                            <label class="form-check-label" for="id_batch_disbursement_type">Check if payment involves multiple recipients</label>
                            <div class="invalid-feedback">Please check the box if this is a batch disbursement.</div>
                        </div>
                    </div>

                    <!-- Batch Disbursement Fields (hidden by default) -->
                    <div class="mb-3 batch-section hidden" id="batch-fields">
                        <label class="form-label fw-bold">Batch Disbursement Details</label>
                        <div class="mb-2">
                            <a href="{% url 'expense:download_batch_template' %}" class="btn btn-outline-primary btn-sm">Download CSV Template</a>
                            <small class="form-text text-muted">Download the template to fill in recipient details (name, amount, mobile, id_number).</small>
                        </div>
                        <div class="mb-2">
                            <label for="id_batch_file" class="form-label fw-bold">Upload Batch File</label>
                            {{ expense_form.batch_file }}
                            <div class="invalid-feedback">Please upload a valid CSV file.</div>
                        </div>
                        
                        <!-- CSV Preview Section (Full Block - Ensure This Is Here) -->
                        <div class="mb-3" id="batch-preview" style="display: none;">
                            <label class="form-label fw-bold">Preview Recipients</label>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered" id="csvPreviewTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Name</th>
                                            <th>Amount (KES)</th>
                                            <th>Mobile Number</th>
                                            <th>ID Number</th>
                                        </tr>
                                    </thead>
                                    <tbody id="csvPreviewBody">
                                        <!-- Rows will be populated by JS -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="previewSummary" class="alert alert-info mt-2" style="display: none;">
                                <strong>Summary:</strong> <span id="totalCount">0</span> recipients | Total Amount: KES <span id="totalAmount">0</span>
                                <div id="validationErrors" class="mt-2 small text-danger"></div>  <!-- Critical: This fixes the null error -->
                            </div>
                        </div>
                        
                        <!-- Hidden field for batch data (JSON serialized) -->
                        <textarea name="batch_data" id="batchData" class="d-none" readonly></textarea>
                    </div>

                    <!-- Expense Category Field -->
                    <div class="mb-3">
                        <label for="id_expense_category" class="form-label fw-bold required">Expense Category</label>
                        {{ expense_form.expense_category }}
                        <div class="invalid-feedback">Please select an expense category.</div>
                    </div>

                    <!-- Wallet Field -->
                    <div class="mb-3 hidden">
                        {{ expense_form.wallet }}
                    </div>

                    <!-- Common Fields -->
                    <div id="common-fields">
                        <div class="mb-3">
                            <label for="id_amount" class="form-label fw-bold required">Amount</label>
                            <div class="input-group">
                                <span class="input-group-text">KES</span>
                                {{ expense_form.amount }}
                                <div class="invalid-feedback">Please enter a valid amount greater than 0.</div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="id_description" class="form-label fw-bold required">Description</label>
                            {{ expense_form.description }}
                            <div class="invalid-feedback">Please provide a description.</div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="btn btn-primary w-100 mt-3" id="expenseSubmitBtn">Submit Request</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- View Request Modal -->
{% for expense in pending_expenses %}
<div class="modal fade" id="viewRequestModal{{ expense.id }}" tabindex="-1" aria-labelledby="viewRequestModalLabel{{ expense.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewRequestModalLabel{{ expense.id }}">Request Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-3 text-muted">Request ID: {{ expense.id }}</h6>
                        <p><strong>Status:</strong> <span class="badge {% if expense.approved %}bg-success{% elif expense.declined %}bg-danger{% else %}bg-warning{% endif %}">{{ expense.status }}</span></p>
                        <p><strong>Request Type:</strong> {{ expense.request_type }}</p>
                        <p><strong>For:</strong> {% if expense.event %}{{ expense.event.name }}{% elif expense.operation %}{{ expense.operation.name }}{% elif expense.activation %}{{ expense.activation.name }}{% else %}General{% endif %}</p>
                        <p><strong>Batch:</strong> {{ expense.batch_disbursement_type|yesno:"Yes,No" }}</p>
                        <p><strong>Category:</strong> {{ expense.expense_category }}</p>
                        <p><strong>Amount:</strong> KES {{ expense.amount|intcomma }}</p>
                        <p><strong>Description:</strong> {{ expense.description }}</p>
                        <p><strong>Submitted By:</strong> {{ expense.created_by.get_full_name }}</p>
                        <p><strong>Submitted On:</strong> {{ expense.created_at|date:"M d, Y" }}</p>
                        {% if expense.approved_by %}
                        <div id="reviewSection">
                            <hr>
                            <p><strong>Reviewed By:</strong> {{ expense.approved_by.get_full_name|default:"-" }}</p>
                            <p><strong>Reviewed On:</strong> {{ expense.updated_at|date:"M d, Y" }}</p>
                            <p><strong>Comments:</strong> {{ expense.review_comments|default:"None" }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- JavaScript -->
<!-- JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing expense modal');
    
    // Check for expenses
    let hasEventExpenses = false;
    let hasOperationExpenses = false;
    let hasActivationExpenses = false;
    
    document.querySelectorAll('#eventsRequestsTable tbody tr').forEach(row => {
        if (!row.querySelector('td[colspan]')) hasEventExpenses = true;
    });
    document.querySelectorAll('#operationsRequestsTable tbody tr').forEach(row => {
        if (!row.querySelector('td[colspan]')) hasOperationExpenses = true;
    });
    document.querySelectorAll('#activationsRequestsTable tbody tr').forEach(row => {
        if (!row.querySelector('td[colspan]')) hasActivationExpenses = true;
    });
    
    if (!hasEventExpenses) {
        document.querySelector('#eventsRequestsTable tbody').innerHTML =
            '<tr><td colspan="9" class="text-center">No event requests found.</td></tr>';
    }
    if (!hasOperationExpenses) {
        document.querySelector('#operationsRequestsTable tbody').innerHTML =
            '<tr><td colspan="9" class="text-center">No operation requests found.</td></tr>';
    }
    if (!hasActivationExpenses) {
        document.querySelector('#activationsRequestsTable tbody').innerHTML =
            '<tr><td colspan="9" class="text-center">No activation requests found.</td></tr>';
    }

    // Sync desktop and mobile tabs
    document.querySelectorAll('#expenseTypeTabs .nav-link').forEach(tab => {
        tab.addEventListener('click', function() {
            const target = this.getAttribute('data-bs-target');
            const mobileTarget = target + '-mobile';
            const mobileTab = document.querySelector(mobileTarget);
            if (mobileTab) {
                document.querySelectorAll('#expenseMobileTabContent .tab-pane').forEach(pane =>
                    pane.classList.remove('show', 'active')
                );
                mobileTab.classList.add('show', 'active');
            }
        });
    });

    // Filter functionality
    const filterButtons = document.querySelectorAll('[data-filter]');
    const searchInput = document.getElementById('requestSearch');
    const requestRows = document.querySelectorAll('.request-row');
    const requestCards = document.querySelectorAll('.request-card');

    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            filterButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            const filter = this.getAttribute('data-filter');
            requestRows.forEach(row => {
                row.style.display =
                    filter === 'all' || row.classList.contains(filter + '-request') ? '' : 'none';
            });
            requestCards.forEach(card => {
                card.style.display =
                    filter === 'all' || card.classList.contains(filter + '-request') ? '' : 'none';
            });
        });
    });

    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        requestRows.forEach(row => {
            row.style.display = row.textContent.toLowerCase().includes(searchTerm) ? '' : 'none';
        });
        requestCards.forEach(card => {
            card.style.display = card.textContent.toLowerCase().includes(searchTerm) ? '' : 'none';
        });
    });

    // Modal initialization
    const submitExpenseModal = document.getElementById('submitExpenseModal');
    if (submitExpenseModal) {
        submitExpenseModal.addEventListener('shown.bs.modal', function() {
            console.log('Modal shown, initializing fields');
            setTimeout(() => {
                initializeExpenseFields();
                attachExpenseFieldListeners();
                toggleBatchFields();
            }, 300);
        });

        submitExpenseModal.addEventListener('hidden.bs.modal', function() {
            const form = document.getElementById('expense-form');
            if (form) {
                form.reset();
                form.classList.remove('was-validated');
                initializeExpenseFields();
            }
            // Reset CSV preview
            resetCsvPreview();
        });
    }

    // Form validation
    const expenseForm = document.getElementById('expense-form');
    const batchCheckbox = document.getElementById('id_batch_disbursement_type');
    const batchFile = document.getElementById('batch_file');
    if (expenseForm && batchCheckbox && batchFile) {
        expenseForm.addEventListener('submit', function(event) {
            if (batchCheckbox.checked && !batchFile.value) {
                batchFile.classList.add('is-invalid');
                event.preventDefault();
                event.stopPropagation();
            } else {
                batchFile.classList.remove('is-invalid');
                batchFile.removeAttribute('required');
            }

            if (!this.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            this.classList.add('was-validated');
        });
    }

    // Attach CSV batch file listener (integrated here to avoid duplicates)
    attachBatchFileListener();
});

// Initialize expense fields to hidden state
function initializeExpenseFields() {
    const eventField = document.getElementById('event-field');
    const operationField = document.getElementById('operation-field');
    const activationField = document.getElementById('activation-field');

    if (eventField && operationField && activationField) {
        eventField.classList.add('hidden');
        operationField.classList.add('hidden');
        activationField.classList.add('hidden');
        document.querySelectorAll('#id_event, #id_operation, #id_activation').forEach(field => {
            if (field) field.removeAttribute('required');
        });
        console.log('All expense fields initialized to hidden');
    } else {
        console.warn('Expense fields not found during initialization');
    }
}

// Attach event listeners for expense fields
function attachExpenseFieldListeners() {
    const requestTypeSelect = document.getElementById('id_request_type');
    const batchCheckbox = document.getElementById('id_batch_disbursement_type');
    console.log('Attaching listeners to:', {
        requestTypeSelect: !!requestTypeSelect,
        batchCheckbox: !!batchCheckbox
    });

    if (requestTypeSelect) {
        // Replace existing listeners
        const newSelect = requestTypeSelect.cloneNode(true);
        requestTypeSelect.parentNode.replaceChild(newSelect, requestTypeSelect);

        newSelect.addEventListener('change', function() {
            console.log('Request type changed to:', this.value, 'Text:', this.options[this.selectedIndex]?.text);
            toggleExpenseFields();
        });

        // Enhanced Nice Select listener logic
        const modalElement = document.getElementById('submitExpenseModal');

        const attachNiceSelectListener = () => {
            const niceSelect = modalElement.querySelector('.nice-select');
            if (niceSelect && !niceSelect.hasAttribute('data-listener-attached')) {
                niceSelect.setAttribute('data-listener-attached', 'true');
                console.log('Nice Select detected, attaching click listener');

                niceSelect.addEventListener('click', function(e) {
                    const option = e.target.closest('.option');
                    if (option) {
                        console.log('Nice Select option clicked:', option.textContent);
                        setTimeout(() => {
                            const hiddenSelect = modalElement.querySelector('select[name="request_type"]');
                            if (hiddenSelect) {
                                console.log('Hidden select value after Nice Select update:', hiddenSelect.value);
                                toggleExpenseFields();
                            }
                        }, 100);
                    }
                });
            }
        };

        // Attach immediately if already rendered
        attachNiceSelectListener();

        // Fallback if created later
        const observer = new MutationObserver(() => attachNiceSelectListener());
        observer.observe(modalElement, { childList: true, subtree: true });
    }

    if (batchCheckbox) {
        batchCheckbox.addEventListener('change', function() {
            console.log('Batch checkbox changed to:', this.checked);
            toggleBatchFields();
        });
    }
}

// Toggle expense form fields
function toggleExpenseFields() {
    const requestTypeSelect =
        document.getElementById('id_request_type') ||
        document.querySelector('select[name="request_type"]');
    const eventField = document.getElementById('event-field');
    const operationField = document.getElementById('operation-field');
    const activationField = document.getElementById('activation-field');

    if (!requestTypeSelect) {
        console.error('Request type select not found');
        return;
    }

    if (!eventField || !operationField || !activationField) {
        console.warn('Form fields not found during toggle:', {
            eventField: !!eventField,
            operationField: !!operationField,
            activationField: !!activationField
        });
        return;
    }

    const selectedValue = requestTypeSelect.value;
    const selectedText =
        requestTypeSelect.options[requestTypeSelect.selectedIndex]?.text?.toLowerCase().trim() || '';
    console.log('Toggling fields - Value:', selectedValue, 'Text:', selectedText);

    [eventField, operationField, activationField].forEach(f => f.classList.add('hidden'));
    document.querySelectorAll('#id_event, #id_operation, #id_activation').forEach(field => {
        if (field) field.removeAttribute('required');
    });

    if (selectedText.includes('event') || selectedValue.includes('event')) {
        eventField.classList.remove('hidden');
        const eventSelect = document.getElementById('id_event');
        if (eventSelect) eventSelect.setAttribute('required', 'required');
        console.log(' Event field shown');
    } else if (selectedText.includes('operation') || selectedValue.includes('operation')) {
        operationField.classList.remove('hidden');
        const operationSelect = document.getElementById('id_operation');
        if (operationSelect) operationSelect.setAttribute('required', 'required');
        console.log(' Operation field shown');
    } else if (selectedText.includes('activation') || selectedValue.includes('activation')) {
        activationField.classList.remove('hidden');
        const activationSelect = document.getElementById('id_activation');
        if (activationSelect) activationSelect.setAttribute('required', 'required');
        console.log(' Activation field shown');
    } else {
        console.log(' No specific field shown for:', selectedText);
    }
}

// Toggle batch disbursement fields
function toggleBatchFields() {
    const batchCheckbox = document.getElementById('id_batch_disbursement_type');
    const batchFields = document.getElementById('batch-fields');
    const batchFile = document.getElementById('batch_file') || document.getElementById('id_batch_file');

    if (!batchCheckbox || !batchFields) {
        console.warn('Batch elements not found:', {
            batchCheckbox: !!batchCheckbox,
            batchFields: !!batchFields,
            batchFile: !!batchFile
        });
        return;
    }

    if (batchCheckbox.checked) {
        batchFields.classList.remove('hidden');
        if (batchFile) batchFile.setAttribute('required', 'required');
        console.log(' Batch fields shown');
    } else {
        batchFields.classList.add('hidden');
        if (batchFile) {
            batchFile.removeAttribute('required');
            batchFile.value = '';
            batchFile.classList.remove('is-invalid');
        }
        console.log(' Batch fields hidden');
    }
}

// CSV Preview Functionality (New: Integrated with safeguards)
function handleBatchFileUpload(fileInput) {
    const file = fileInput.files[0];
    if (!file) return;

    // Validate file type
    if (!file.name.toLowerCase().endsWith('.csv')) {
        alert('Please upload a valid CSV file.');
        fileInput.value = '';
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        const csvContent = e.target.result;
        const rows = parseCsvContent(csvContent);  // Renamed to avoid any potential conflicts
        renderCsvPreview(rows);  // Renamed for clarity
        updateBatchData(rows); // Set all rows for submission
    };
    reader.readAsText(file);
}

function parseCsvContent(csv) {  // Renamed from parseCSV to avoid global conflicts
    const lines = csv.split('\n').filter(line => line.trim() !== '');
    if (lines.length < 2) {
        alert('CSV must have at least a header row and one data row.');
        return [];
    }

    // Parse and normalize headers
    let headers = lines[0].split(',').map(h => normalizeCsvHeader(h.trim().toLowerCase()));  // Renamed helper
    console.log('Detected raw headers:', lines[0].split(',').map(h => h.trim())); // Debug
    console.log('Normalized headers:', headers); // Debug

    // Check for required fields after normalization
    const requiredMapped = ['name', 'amount', 'mobile', 'id_number'];
    const hasAllRequired = requiredMapped.every(req => headers.includes(req));
    if (!hasAllRequired) {
        const detected = lines[0].split(',').map(h => h.trim()).join(', ');
        alert(`CSV headers mismatch. Detected: "${detected}". Expected (or similar): name, amount, mobile, id_number. Update your CSV to match.`);
        return [];
    }

    // Parse data rows
    const dataRows = lines.slice(1).map((line, rowIndex) => {
        if (!line.trim()) return null; // Skip empty rows
        const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
        const rowObj = {};
        headers.forEach((header, i) => {
            rowObj[header] = values[i] || '';
        });
        return rowObj;
    }).filter(row => row !== null);

    // Filter rows with all required fields populated
    const validRows = dataRows.filter(row => 
        row.name && row.amount && row.mobile && row.id_number
    );

    if (validRows.length === 0 && dataRows.length > 0) {
        alert('No valid data rows found. Ensure all rows have values for name, amount, mobile, and id_number.');
    }

    return validRows;
}

// Normalize CSV header variations to standard names (Renamed helper)
function normalizeCsvHeader(header) {
    // Trim and lowercase already done in parseCsvContent
    if (header.includes('file name') || header.includes('filename') || header === 'name') return 'name';
    if (header.includes('mobile') || header.includes('phone') || header === 'mobile_number') return 'mobile';
    if (header === 'amount') return 'amount';
    if (header.includes('id') && header.includes('number')) return 'id_number';
    // If no match, keep as-is (will fail validation)
    return header;
}

function renderCsvPreview(rows) {  // Renamed from renderPreviewTable
    const tbody = document.getElementById('csvPreviewBody');
    const previewDiv = document.getElementById('batch-preview');
    const summaryDiv = document.getElementById('previewSummary');
    const errorsDiv = document.getElementById('validationErrors');

    // Null checks with fallbacks
    if (!tbody) {
        console.error('Element #csvPreviewBody not found. Check HTML.');
        alert('Preview setup error: Table body missing. Refresh and try again.');
        return;
    }
    if (!previewDiv) {
        console.error('Element #batch-preview not found. Check HTML.');
        alert('Preview setup error: Container missing. Refresh and try again.');
        return;
    }
    if (!summaryDiv) {
        console.error('Element #previewSummary not found. Check HTML.');
        // Continue without summary (non-critical)
    }

    if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No valid recipients found in CSV. Check headers and data.</td></tr>';
        previewDiv.style.display = 'block';
        if (summaryDiv) summaryDiv.style.display = 'none';
        return;
    }

    let html = '';
    let validationErrors = [];

    rows.forEach((row, index) => {
        const amount = parseFloat(row.amount);
        const isValidAmount = !isNaN(amount) && amount > 0;
        const isValidMobile = /^\d{10,15}$/.test(row.mobile.replace(/\D/g, '')); // 10-15 digits, strip non-digits
        const isValidId = /^\d{7,10}$/.test(row.id_number.replace(/\D/g, '')); // 7-10 digits for ID

        if (!isValidAmount) validationErrors.push(`Row ${index + 2}: Invalid amount "${row.amount}" (must be positive number)`);
        if (!isValidMobile) validationErrors.push(`Row ${index + 2}: Invalid mobile "${row.mobile}" (10-15 digits)`);
        if (!isValidId) validationErrors.push(`Row ${index + 2}: Invalid ID "${row.id_number}" (7-10 digits)`);

        html += `
            <tr>
                <td>${row.name || 'N/A'}</td>
                <td>${isValidAmount ? 'KES ' + amount.toLocaleString() : '<span class="text-danger">' + row.amount + '</span>'}</td>
                <td>${isValidMobile ? row.mobile : '<span class="text-danger">' + row.mobile + '</span>'}</td>
                <td>${isValidId ? row.id_number : '<span class="text-danger">' + row.id_number + '</span>'}</td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
    previewDiv.style.display = 'block';

    // Safe summary and errors update
    if (summaryDiv) {
        summaryDiv.style.display = 'block';
        updateCsvSummary(rows);  // Renamed
    } else {
        console.warn('Summary div not available; skipping summary display.');
    }

    if (errorsDiv) {
        errorsDiv.innerHTML = validationErrors.length > 0 ? validationErrors.join('<br>') : '<span class="text-success">All rows valid!</span>';
    } else {
        console.error('Element #validationErrors not found. Check HTML for <div id="validationErrors">.');
        // Optional: Alert if critical, or just log
    }
}

function updateCsvSummary(rows) {  // Renamed from updateSummary
    const totalCountEl = document.getElementById('totalCount');
    const totalAmountEl = document.getElementById('totalAmount');

    if (!totalCountEl || !totalAmountEl) {
        console.error('Summary elements (#totalCount or #totalAmount) not found.');
        return;
    }

    const totalCount = rows.length;
    let totalAmount = 0;

    rows.forEach(row => {
        totalAmount += parseFloat(row.amount) || 0;
    });

    totalCountEl.textContent = totalCount;
    totalAmountEl.textContent = totalAmount.toLocaleString();
}

function updateBatchData(rows) {
    const batchDataEl = document.getElementById('batchData');
    if (batchDataEl) {
        batchDataEl.value = JSON.stringify(rows);
    } else {
        console.error('Element #batchData not found. Batch data won\'t be submitted.');
    }
}

// Attach batch file listener (New: Dedicated function to avoid duplicates)
function attachBatchFileListener() {
    const batchFileInput = document.getElementById('id_batch_file') || document.querySelector('input[name="batch_file"]');
    if (batchFileInput && !batchFileInput.hasAttribute('data-csv-listener')) {  // Prevent multiple attachments
        batchFileInput.setAttribute('data-csv-listener', 'true');
        batchFileInput.addEventListener('change', function() {
            handleBatchFileUpload(this);
        });
        console.log('CSV batch file listener attached.');
    } else if (!batchFileInput) {
        console.error('Batch file input not found. Check form field ID/name.');
    }
}

// Reset CSV preview (New: For modal hide)
function resetCsvPreview() {
    const previewDiv = document.getElementById('batch-preview');
    const summaryDiv = document.getElementById('previewSummary');
    const batchFileInput = document.getElementById('id_batch_file') || document.querySelector('input[name="batch_file"]');
    if (previewDiv) previewDiv.style.display = 'none';
    if (summaryDiv) summaryDiv.style.display = 'none';
    if (batchFileInput) batchFileInput.value = '';
    updateBatchData([]);
    const tbody = document.getElementById('csvPreviewBody');
    if (tbody) tbody.innerHTML = '';
}
</script>

<style>
    .hidden {
        display: none !important;
    }
</style>
{% endblock %}