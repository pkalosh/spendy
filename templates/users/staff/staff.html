{% extends "partials/user-base.html" %}
{% load static %}
{% load humanize %}
{% block content %}
<!-- Dashboard Section start -->
 
<style>
  .hidden {
    display: none !important;
  }
</style>
<section class="dashboard-section body-collapse">
    <div class="overlay pt-120">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <!-- Wallets Section -->
                    <div id="wallets" class="content-section mb-5">
                        <h4 class="text-2xl font-bold mb-4">Wallet </h4>
                        <div class="row">
                            <div class="col-md-12 mb-4 col-sm-12">
                                <div class="bg-white p-4 shadow rounded-md h-100">
                                    <p> Current wallet balance and transactions.</p>
                                    <p class="text-xl font-bold">
                                        KES: {{ wallet|floatformat:2 }}
                                    </p>
                                </div>
                            </div>
           
                        </div>
                    </div>

                    <!-- Expense Management Section -->
                    <div class="transactions-area mb-5">
                        <div class="row mb-4">
                            <!-- Navigation tabs - full width on mobile -->
                            <div class="col-lg-8 col-md-7 col-12 mb-3 mb-md-0">
                                <div class="nav nav-tabs flex-nowrap overflow-auto" role="tablist">
                                    <button class="nav-link active flex-shrink-0" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab" aria-controls="pending" aria-selected="true">
                                        Pending Requests
                                    </button>
                                    <button class="nav-link flex-shrink-0" id="approved-tab" data-bs-toggle="tab" data-bs-target="#approved" type="button" role="tab" aria-controls="approved" aria-selected="false">
                                        Approved Expenses
                                    </button>
                                    <button class="nav-link flex-shrink-0" id="declined-tab" data-bs-toggle="tab" data-bs-target="#declined" type="button" role="tab" aria-controls="declined" aria-selected="false">
                                        Declined Expenses
                                    </button>
                                    <button class="nav-link flex-shrink-0" id="payments-tab" data-bs-toggle="tab" data-bs-target="#payment" type="button" role="tab" aria-controls="payment" aria-selected="false">
                                        Payment Transactions
                                    </button>
                                </div>
                            </div>
                            <!-- Action buttons - stack on mobile -->
                            <div class="col-lg-4 col-md-5 col-12 d-flex justify-content-md-end justify-content-center">
                                <div class="d-flex flex-column flex-sm-row gap-2">
                                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#submitExpenseModal">
                                        Submit Expense Request
                                    </button>
                                    {% if not is_admin %}
                                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#makePaymentModal">
                                        Make Payment
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="tab-content">
                            <!-- Pending Expenses Tab -->
                            <div class="tab-pane fade show active" id="pending" role="tabpanel" aria-labelledby="pending-tab">
                                <div class="table-responsive d-none d-md-block">
                                    <table class="table table-bordered table-hover">
                                        <thead class="bg-light">
                                            <tr>
                                                <th>Expense Group</th>
                                                <th class="d-none d-md-table-cell">Related Item</th>
                                                <th>Amount</th>
                                                <th class="d-none d-md-table-cell">Date Requested</th>
                                                <th class="d-none d-lg-table-cell">Requested By</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for expense in pending_expenses %}
                                            <tr>
                                                <td>{{ expense.get_expense_group_display }}</td>
                                                <td class="d-none d-md-table-cell">
                                                    {% if expense.expense_group == 'EVENT' %}
                                                        {{ expense.event.name }}
                                                    {% else %}
                                                        {{ expense.operation.name }}
                                                    {% endif %}
                                                </td>
                                                <td>{{ expense.amount|intcomma }}</td>
                                                <td class="d-none d-md-table-cell">{{ expense.created_at|date:"M d, Y" }}</td>
                                                <td class="d-none d-lg-table-cell">{{ expense.created_by.get_full_name }}</td>
                                                <td>
                                                    <div class="d-flex flex-column flex-sm-row gap-1">
                                                        <a href="{% url 'expense:expense_detail' expense.id %}" class="btn btn-sm btn-info mb-1 mb-sm-0">View</a>
                                                        {% if is_admin %}
                                                        <a href="{% url 'expense:expense_detail' expense.id %}" class="btn btn-sm btn-success">Approve/Decline</a>
                                                        {% endif %}
                                                    </div>
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="6" class="text-center text-gray-500">No pending expense requests found.</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                <!-- Mobile-only expense cards for better readability -->
                                <div class="d-md-none">
                                    {% for expense in pending_expenses %}
                                    <div class="card mb-3">
                                        <div class="card-body">
                                            <h6 class="card-subtitle mb-2 text-muted">{{ expense.get_expense_group_display }}</h6>
                                            <p class="card-text">
                                                <strong>Amount:</strong> {{ expense.amount|intcomma }}<br>
                                                <strong>Related Item:</strong>
                                                {% if expense.expense_group == 'EVENT' %}
                                                    {{ expense.event.name }}
                                                {% else %}
                                                    {{ expense.operation.name }}
                                                {% endif %}<br>
                                                <strong>Date:</strong> {{ expense.created_at|date:"M d, Y" }}<br>
                                                <strong>Requested By:</strong> {{ expense.created_by.get_full_name }}
                                            </p>
                                            <div class="d-flex gap-2">
                                                <a href="{% url 'expense:expense_detail' expense.id %}" class="btn btn-sm btn-info">View</a>
                                                {% if is_admin %}
                                                <a href="{% url 'expense:expense_detail' expense.id %}" class="btn btn-sm btn-success">Approve/Decline</a>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="alert alert-info">No pending expense requests found.</div>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Approved Expenses Tab -->
                            <div class="tab-pane fade" id="approved" role="tabpanel" aria-labelledby="approved-tab">
                                <div class="table-responsive d-none d-md-block">
                                    <table class="table table-bordered table-hover">
                                        <thead class="bg-light">
                                            <tr>
                                                <th>Expense Group</th>
                                                <th class="d-none d-md-table-cell">Related Item</th>
                                                <th>Amount</th>
                                                <th class="d-none d-md-table-cell">Date Approved</th>
                                                <th class="d-none d-lg-table-cell">Approved By</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for expense in approved_expenses %}
                                            <tr>
                                                <td>{{ expense.get_expense_group_display }}</td>
                                                <td class="d-none d-md-table-cell">
                                                    {% if expense.expense_group == 'EVENT' %}
                                                        {{ expense.event.name }}
                                                    {% else %}
                                                        {{ expense.operation.name }}
                                                    {% endif %}
                                                </td>
                                                <td>{{ expense.amount|intcomma }}</td>
                                                <td class="d-none d-md-table-cell">{{ expense.updated_at|date:"M d, Y" }}</td>
                                                <td class="d-none d-lg-table-cell">{{ expense.approved_by.get_full_name }}</td>
                                                <td>
                                                    <div class="d-flex flex-column flex-sm-row gap-1">
                                                        <a href="{% url 'expense:expense_detail' expense.id %}" class="btn btn-sm btn-info mb-1 mb-sm-0">View</a>
                                                        {% if not is_admin %}
                                                        <button class="btn btn-sm btn-success" onclick="preparePayment('{{ expense.id }}')">Pay</button>
                                                        {% endif %}
                                                    </div>
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="6" class="text-center text-gray-500">No approved expenses found.</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                <!-- Mobile-only expense cards for better readability -->
                                <div class="d-md-none">
                                    {% for expense in approved_expenses %}
                                    <div class="card mb-3">
                                        <div class="card-body">
                                            <h6 class="card-subtitle mb-2 text-muted">{{ expense.get_expense_group_display }}</h6>
                                            <p class="card-text">
                                                <strong>Amount:</strong> {{ expense.amount|intcomma }}<br>
                                                <strong>Related Item:</strong>
                                                {% if expense.expense_group == 'EVENT' %}
                                                    {{ expense.event.name }}
                                                {% else %}
                                                    {{ expense.operation.name }}
                                                {% endif %}<br>
                                                <strong>Date:</strong> {{ expense.updated_at|date:"M d, Y" }}<br>
                                                <strong>Approved By:</strong> {{ expense.approved_by.get_full_name }}
                                            </p>
                                            <div class="d-flex gap-2">
                                                <a href="{% url 'expense:expense_detail' expense.id %}" class="btn btn-sm btn-info">View</a>
                                                {% if not is_admin %}
                                                <button class="btn btn-sm btn-success" onclick="preparePayment('{{ expense.id }}')">Pay</button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="alert alert-info">No approved expenses found.</div>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Declined Expenses Tab -->
                            <div class="tab-pane fade" id="declined" role="tabpanel" aria-labelledby="declined-tab">
                                <div class="table-responsive d-none d-md-block">
                                    <table class="table table-bordered table-hover">
                                        <thead class="bg-light">
                                            <tr>
                                                <th>Expense Group</th>
                                                <th class="d-none d-md-table-cell">Related Item</th>
                                                <th>Amount</th>
                                                <th class="d-none d-md-table-cell">Date Declined</th>
                                                <th class="d-none d-lg-table-cell">Declined By</th>
                                                <th class="d-none d-md-table-cell">Reason</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for expense in declined_expenses %}
                                            <tr>
                                                <td>{{ expense.get_expense_group_display }}</td>
                                                <td class="d-none d-md-table-cell">
                                                    {% if expense.expense_group == 'EVENT' %}
                                                        {{ expense.event.name }}
                                                    {% else %}
                                                        {{ expense.operation.name }}
                                                    {% endif %}
                                                </td>
                                                <td>{{ expense.amount|intcomma }}</td>
                                                <td class="d-none d-md-table-cell">{{ expense.updated_at|date:"M d, Y" }}</td>
                                                <td class="d-none d-lg-table-cell">{{ expense.approved_by.get_full_name }}</td>
                                                <td class="d-none d-md-table-cell">{{ expense.decline_reason }}</td>
                                                <td>
                                                    <a href="{% url 'expense:expense_detail' expense.id %}" class="btn btn-sm btn-info">View</a>
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="7" class="text-center text-gray-500">No declined expenses found.</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                <!-- Mobile-only expense cards for better readability -->
                                <div class="d-md-none">
                                    {% for expense in declined_expenses %}
                                    <div class="card mb-3">
                                        <div class="card-body">
                                            <h6 class="card-subtitle mb-2 text-muted">{{ expense.get_expense_group_display }}</h6>
                                            <p class="card-text">
                                                <strong>Amount:</strong> {{ expense.amount|intcomma }}<br>
                                                <strong>Related Item:</strong>
                                                {% if expense.expense_group == 'EVENT' %}
                                                    {{ expense.event.name }}
                                                {% else %}
                                                    {{ expense.operation.name }}
                                                {% endif %}<br>
                                                <strong>Date:</strong> {{ expense.updated_at|date:"M d, Y" }}<br>
                                                <strong>Declined By:</strong> {{ expense.approved_by.get_full_name }}<br>
                                                <strong>Reason:</strong> {{ expense.decline_reason }}
                                            </p>
                                            <div class="d-flex">
                                                <a href="{% url 'expense:expense_detail' expense.id %}" class="btn btn-sm btn-info">View</a>
                                            </div>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="alert alert-info">No declined expenses found.</div>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Payment Transactions Tab -->
                            <div class="tab-pane fade" id="payment" role="tabpanel" aria-labelledby="payment-tab">
                                <div class="table-responsive d-none d-md-block">
                                    <table class="table table-bordered table-hover">
                                    <thead class="bg-light">
                                        <tr>
                                            <th>Transaction ID</th>
                                            <th>Company</th>
                                            <th>Initiated By</th>
                                            <th>Event/Operation</th>
                                            <th>Recipient</th>
                                            <th>Amount</th>
                                            <th>Type</th>
                                            <th>Status</th>
                                            <th>Date</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for txn in transactions %}
                                            <tr>
                                                <td>{{ txn.transaction_id }}</td>
                                                <td>{{ txn.company.company_name|default:"-" }}</td>
                                                <td>{{ txn.user.get_full_name|default:"-" }}</td>
                                                <td>{{ txn.event.name|default:"-" }}</td>
                                                <td>{{ txn.reciever.get_full_name|default:"-" }}</td>
                                                <td>{{ txn.sender_wallet.currency|default:"" }} {{ txn.amount|floatformat:2|intcomma }}</td>
                                                <td>{{ txn.transaction_type|title }}</td>
                                                <td>
                                                    {% if txn.status == 'completed' %}
                                                        <span class="badge bg-success">{{ txn.status|title }}</span>
                                                    {% elif txn.status == 'failed' or txn.status == 'cancelled' %}
                                                        <span class="badge bg-danger">{{ txn.status|title }}</span>
                                                    {% else %}
                                                        <span class="badge bg-warning">{{ txn.status|title }}</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ txn.date|date:"M d, Y H:i" }}</td>
                                                <td>
                                                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#viewTransactionModal{{ txn.transaction_id }}">View</button>
                                                </td>
                                            </tr>

                                            <!-- View Transaction Modal -->
                                            <div class="modal fade" id="viewTransactionModal{{ txn.transaction_id }}" tabindex="-1" aria-labelledby="viewTransactionModalLabel{{ txn.transaction_id }}" aria-hidden="true">
                                                <div class="modal-dialog modal-lg" style="margin-top: 80px;">
                                                  <div class="modal-content">
                                                    <div class="modal-header">
                                                      <h5 class="modal-title" id="viewTransactionModalLabel{{ txn.transaction_id }}">Transaction Details</h5>
                                                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                      <div class="row mb-3">
                                                        <div class="col-md-6">
                                                            <strong>Transaction ID:</strong> {{ txn.transaction_id }}
                                                        </div>
                                                        <div class="col-md-6">
                                                            <strong>Amount:</strong> {{ txn.sender_wallet.currency|default:"" }} {{ txn.amount|floatformat:2|intcomma }}
                                                        </div>
                                                      </div>
                                                      <div class="row mb-3">
                                                        <div class="col-md-6">
                                                            <strong>Sender:</strong> {{ txn.sender.get_full_name }}
                                                        </div>
                                                        <div class="col-md-6">
                                                            <strong>Receiver:</strong> {{ txn.reciever.get_full_name }}
                                                        </div>
                                                      </div>
                                                      <div class="row mb-3">
                                                        <div class="col-md-6">
                                                            <strong>Sender Wallet:</strong> {{ txn.sender_wallet.wallet_id }}
                                                        </div>
                                                        <div class="col-md-6">
                                                            <strong>Receiver Wallet:</strong> {{ txn.reciever_wallet.wallet_id }}
                                                        </div>
                                                      </div>
                                                      <div class="row mb-3">
                                                        <div class="col-md-6">
                                                            <strong>Status:</strong> {{ txn.status|title }}
                                                        </div>
                                                        <div class="col-md-6">
                                                            <strong>Transaction Type:</strong> {{ txn.transaction_type|title }}
                                                        </div>
                                                      </div>
                                                      <div class="row mb-3">
                                                        <div class="col-md-12">
                                                            <strong>Description:</strong><br>
                                                            {{ txn.description }}
                                                        </div>
                                                      </div>
                                                      <div class="row">
                                                        <div class="col-md-6">
                                                            <strong>Date Created:</strong> {{ txn.date|date:"Y-m-d H:i" }}
                                                        </div>
                                                        <div class="col-md-6">
                                                            <strong>Last Updated:</strong> {{ txn.updated|date:"Y-m-d H:i" }}
                                                        </div>
                                                      </div>
                                                    </div>
                                                  </div>
                                                </div>
                                            </div>
                                        {% endfor %}

                                        {% if not transactions %}
                                            <tr>
                                                <td colspan="11" class="text-center">No transactions available.</td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                    </table>
                                </div>
                                
                                <!-- Mobile-only transaction cards -->
                                <div class="d-md-none">
                                    {% for txn in transactions %}
                                    <div class="card mb-3">
                                        <div class="card-body">
                                            <h6 class="card-subtitle mb-2 text-muted">{{ txn.transaction_id }}</h6>
                                            <p class="card-text">
                                                <strong>Amount:</strong> {{ txn.sender_wallet.currency|default:"" }} {{ txn.amount|floatformat:2|intcomma }}<br>
                                                <strong>From:</strong> {{ txn.sender.get_full_name }}<br>
                                                <strong>To:</strong> {{ txn.reciever.get_full_name }}<br>
                                                <strong>Type:</strong> {{ txn.transaction_type|title }}<br>
                                                <strong>Status:</strong> 
                                                {% if txn.status == 'completed' %}
                                                    <span class="badge bg-success">{{ txn.status|title }}</span>
                                                {% elif txn.status == 'failed' or txn.status == 'cancelled' %}
                                                    <span class="badge bg-danger">{{ txn.status|title }}</span>
                                                {% else %}
                                                    <span class="badge bg-warning">{{ txn.status|title }}</span>
                                                {% endif %}<br>
                                                <strong>Date:</strong> {{ txn.date|date:"M d, Y" }}
                                            </p>
                                            <div class="d-flex">
                                                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#viewTransactionModal{{ txn.transaction_id }}">View Details</button>
                                            </div>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="alert alert-info">No transactions available.</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div> <!-- End col-12 -->
            </div> <!-- End row -->
        </div> <!-- End container-fluid -->
    </div> <!-- End overlay -->
</section>
<!-- Submit Expense Modal -->
<div class="modal fade" id="submitExpenseModal" tabindex="-1" aria-labelledby="submitExpenseModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-light">
        <h5 class="modal-title">Submit Expense Request</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Request Form -->
        <div id="requests" class="content-section">
          <h3 class="mb-3">Make a Request</h3>
          <p class="text-muted mb-4">Request funds for an event or operation.</p>
          <form id="expenseForm" class="bg-white p-4 shadow rounded" method="post" action="{% url 'expense:submit_expense' %}">
            {% csrf_token %}
            <input type="hidden" name="form_type" id="form_type" value="">
            <input type="hidden" name="budget" id="hidden_budget" value="">
            
            <!-- Request Type -->
            <div class="mb-3">
              <label for="requestType" class="form-label fw-bold">Request Type</label>
              <select id="requestType" name="request_type" class="form-select" onchange="toggleRequestFields()" required>
                <option value="">Select Type</option>
                <option value="event">Event</option>
                <option value="operation">Operation</option>
              </select>
            </div>
            
            <!-- Event Request Fields -->
            <div id="eventRequestFields" class="hidden">
              <div class="mb-3">
                <label for="event_name" class="form-label">Event Name</label>
                <input type="text" id="event_name" name="event_name" class="form-control event-field" maxlength="255">
              </div>
              
              <div class="mb-3">
                <label for="event_category" class="form-label">Event Category</label>
                <select id="event_category" name="event_category" class="form-select event-field">
                  <option value="">Select Category</option>
                  {% for category in event_categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                  {% endfor %}
                </select>
              </div>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="event_start_date" class="form-label">Start Date</label>
                  <input type="date" id="event_start_date" name="event_start_date" class="form-control event-field">
                </div>
                <div class="col-md-6 mb-3">
                  <label for="event_end_date" class="form-label">End Date</label>
                  <input type="date" id="event_end_date" name="event_end_date" class="form-control event-field">
                </div>
              </div>
              <div class="mb-3">
                <label for="event_budget" class="form-label">Budget</label>
                <input type="number" id="event_budget" name="event_budget" class="form-control budget-field event-field" step="0.01">
              </div>
              <div class="mb-3">
                <label for="event_description" class="form-label">Description</label>
                <textarea id="event_description" name="event_description" class="form-control event-field" rows="3"></textarea>
              </div>
              
              <div class="mb-3">
                <label for="event_project_lead" class="form-label">Project Lead</label>
                <input type="text" id="event_project_lead" name="event_project_lead" class="form-control event-field" maxlength="255">
              </div>
              
              <div class="mb-3">
                <label for="event_location" class="form-label">Location</label>
                <input type="text" id="event_location" name="event_location" class="form-control event-field" maxlength="255">
              </div>
            </div>
            
            <!-- Operation Request Fields -->
            <div id="operationRequestFields" class="hidden">
              <div class="mb-3">
                <label for="operation_name" class="form-label">Operation Name</label>
                <input type="text" id="operation_name" name="operation_name" class="form-control operation-field" maxlength="255">
              </div>
              
              <div class="mb-3">
                <label for="operation_category" class="form-label">Operation Category</label>
                <select id="operation_category" name="operation_category" class="form-select operation-field">
                  <option value="">Select Category</option>
                  {% for category in operation_categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-3">
                <label for="operation_budget" class="form-label">Budget</label>
                <input type="number" id="operation_budget" name="operation_budget" class="form-control budget-field operation-field" step="0.01">
              </div>
              <div class="mb-3">
                <label for="operation_description" class="form-label">Description</label>
                <textarea id="operation_description" name="operation_description" class="form-control operation-field" rows="3"></textarea>
              </div>
              
              <div class="mb-3">
                <label for="operation_project_lead" class="form-label">Project Lead</label>
                <input type="text" id="operation_project_lead" name="operation_project_lead" class="form-control operation-field" maxlength="255">
              </div>
            </div>
            
            <button type="submit" class="btn btn-primary mt-3">Submit Request</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Make Payment Modal -->
<div class="modal fade" id="makePaymentModal" tabindex="-1" aria-labelledby="makePaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 id="makePaymentModalLabel" class="modal-title">Make Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form class="p-3" method="post" action="{% url 'expense:make_payment' %}" id="paymentForm">
                    {% csrf_token %}
                    
                    <!-- Select Expense -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Select Expense to Pay</label>
                        {{ payment_form.expense }}
                    </div>
                    
                    <!-- Payment Method -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Payment Method</label>
                        {{ payment_form.payment_method }}
                    </div>
                    
                    <!-- M-Pesa Number -->
                    <div id="mpesaNumberSection" class="mb-3">
                        <label class="form-label fw-bold">M-Pesa Number</label>
                        {{ payment_form.mpesa_number }}
                        <small class="text-muted">Enter a valid 10-12 digit phone number</small>
                    </div>
                    
                    <!-- Paybill Section -->
                    <div id="paybillSection" class="mb-3" style="display: none;">
                        <label class="form-label fw-bold">Paybill Number</label>
                        {{ payment_form.paybill_number }}
                        <small class="text-muted">Enter a valid 5-6 digit paybill number</small>
                        
                        <label class="form-label mt-3 fw-bold">Account Number</label>
                        {{ payment_form.account_number }}
                    </div>
                    
                    <!-- Till Number Section -->
                    <div id="tillNumberSection" class="mb-3" style="display: none;">
                        <label class="form-label fw-bold">Till Number</label>
                        {{ payment_form.till_number }}
                        <small class="text-muted">Enter a valid 5-6 digit till number</small>
                    </div>
                    
                    <button class="btn btn-success w-100 mt-4" type="submit">Process Payment</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap 5 + JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>


<script>
function toggleRequestFields() {
  let requestType = document.getElementById('requestType').value;
  document.getElementById('form_type').value = requestType;
  
  // Show/hide appropriate fields
  document.getElementById('eventRequestFields').classList.toggle('hidden', requestType !== 'event');
  document.getElementById('operationRequestFields').classList.toggle('hidden', requestType !== 'operation');
  
  // First, remove required attribute from all fields to avoid validation issues when hidden
  const allFields = document.querySelectorAll('.event-field, .operation-field');
  allFields.forEach(field => field.removeAttribute('required'));
  
  // Handle field requirements based on request type
  if (requestType === 'event') {
    // Make visible event fields required
    const eventFields = document.querySelectorAll('.event-field');
    eventFields.forEach(field => {
      field.setAttribute('required', '');
    });
    
    // Remove operation budget's required attribute since it's hidden
    const operationBudget = document.getElementById('operation_budget');
    if (operationBudget) {
      operationBudget.removeAttribute('required');
    }
  } else if (requestType === 'operation') {
    // Make visible operation fields required
    const operationFields = document.querySelectorAll('.operation-field');
    operationFields.forEach(field => {
      field.setAttribute('required', '');
    });
    
    // Remove event budget's required attribute since it's hidden
    const eventBudget = document.getElementById('event_budget');
    if (eventBudget) {
      eventBudget.removeAttribute('required');
    }
  }
}

// Form validation and submission
document.addEventListener('DOMContentLoaded', function() {
  const expenseForm = document.getElementById('expenseForm');
  
  // Make sure the correct fields are required/not required when the page loads
  toggleRequestFields();
  
  // Setup budget field listeners
  const eventBudget = document.getElementById('event_budget');
  const operationBudget = document.getElementById('operation_budget');
  const hiddenBudget = document.getElementById('hidden_budget');
  
  eventBudget.addEventListener('input', function() {
    hiddenBudget.value = this.value;
  });
  
  operationBudget.addEventListener('input', function() {
    hiddenBudget.value = this.value;
  });
  
  expenseForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const requestType = document.getElementById('requestType').value;
    let isValid = true;
    
    // Basic validation
    if (!requestType) {
      alert('Please select a request type');
      isValid = false;
    }
    
    if (requestType === 'event') {
      // Validate event fields
      const eventName = document.getElementById('event_name').value;
      const eventCategory = document.getElementById('event_category').value;
      const eventStartDate = document.getElementById('event_start_date').value;
      const eventBudget = document.getElementById('event_budget').value;
      const eventEndDate = document.getElementById('event_end_date').value;
      const eventProjectLead = document.getElementById('event_project_lead').value;
      const eventLocation = document.getElementById('event_location').value;
      
      // Update hidden budget field
      hiddenBudget.value = eventBudget;
      
      if (!eventName || !eventCategory || !eventStartDate || !eventEndDate || 
          !eventProjectLead || !eventLocation || !eventBudget) {
        alert('Please fill out all required event fields');
        isValid = false;
      }
      
      // Validate dates
      if (eventStartDate && eventEndDate && new Date(eventStartDate) > new Date(eventEndDate)) {
        alert('End date must be after start date');
        isValid = false;
      }
    } else if (requestType === 'operation') {
      // Validate operation fields
      const operationName = document.getElementById('operation_name').value;
      const operationCategory = document.getElementById('operation_category').value;
      const operationBudget = document.getElementById('operation_budget').value;
      const operationProjectLead = document.getElementById('operation_project_lead').value;
      
      // Update hidden budget field
      hiddenBudget.value = operationBudget;
      
      if (!operationName || !operationCategory || !operationBudget) {
        alert('Please fill out all required operation fields');
        isValid = false;
      }
    }
    
    if (isValid) {
      this.submit();
    }
  });
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>


{% endblock %}